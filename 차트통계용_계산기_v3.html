<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>매매 기록 통계</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        h1 {
            color: white;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }
        
        h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.5em;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }
        
        .stock-item {
            background: #f5f5f5;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 5px solid #667eea;
        }
        
        .stock-result {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 15px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            margin-top: 10px;
        }
        
        .result-box {
            text-align: center;
        }
        
        .result-label {
            font-size: 0.85em;
            color: #666;
            margin-bottom: 5px;
        }
        
        .result-value {
            font-size: 1.2em;
            font-weight: bold;
        }
        
        .profit {
            color: #f44336;
        }
        
        .loss {
            color: #2196f3;
        }
        
        input[type="text"] {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: 600;
            font-size: 0.9em;
        }
        
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .btn-add {
            background: #4caf50;
            color: white;
            width: 100%;
            padding: 15px;
            font-size: 16px;
        }
        
        .btn-add:hover {
            background: #45a049;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(76,175,80,0.3);
        }
        
        .btn-delete {
            background: #f44336;
            color: white;
            padding: 8px 15px;
        }
        
        .btn-delete:hover {
            background: #da190b;
        }
        
        .btn-delete-row {
            background: #f44336;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .btn-delete-row:hover {
            background: #da190b;
        }
        
        .btn-add-buy {
            background: #4caf50;
            color: white;
            transition: all 0.3s;
        }
        
        .btn-add-buy:hover {
            background: #45a049;
            transform: translateY(-1px);
        }
        
        .btn-calculate {
            background: #667eea;
            color: white;
            padding: 10px 20px;
        }
        
        .btn-calculate:hover {
            background: #5568d3;
        }
        
        .action-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .btn-export {
            background: #2e7d32;
            color: white;
            padding: 15px;
            font-size: 16px;
        }
        
        .btn-export:hover {
            background: #1b5e20;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(46,125,50,0.3);
        }
        
        .btn-reset {
            background: #9e9e9e;
            color: white;
            padding: 15px;
            font-size: 16px;
        }
        
        .btn-reset:hover {
            background: #757575;
        }
        
        .statistics-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-top: 20px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        
        .stat-title {
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 10px;
        }
        
        .stat-value {
            font-size: 1.8em;
            font-weight: bold;
        }
        
        .total-stats {
            background: #fff3cd;
            padding: 20px;
            border-radius: 10px;
            border: 3px solid #ffc107;
        }
        
        .total-stats h3 {
            color: #856404;
            margin-bottom: 20px;
            text-align: center;
        }
        
        @media (max-width: 1024px) {
            .stock-result {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .statistics-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 768px) {
            .action-buttons {
                grid-template-columns: 1fr;
            }
            
            .statistics-grid {
                grid-template-columns: 1fr;
            }
            
            .stock-result {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .buy-row {
                grid-template-columns: 1fr 1fr !important;
            }
            
            .buy-row > div {
                grid-column: span 1;
            }
            
            .buy-row > div:nth-child(6),
            .buy-row > div:nth-child(7) {
                grid-column: span 2;
            }
        }
        
        .btn-google {
            background: #4285f4;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-google:hover {
            background: #357ae8;
            transform: translateY(-1px);
        }
        
        .btn-google:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        
        .btn-backup {
            background: #10b981;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-backup:hover:not(:disabled) {
            background: #059669;
            transform: translateY(-1px);
        }
        
        .btn-backup:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            opacity: 0.5;
        }
        
        .btn-load {
            background: #f59e0b;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-load:hover:not(:disabled) {
            background: #d97706;
            transform: translateY(-1px);
        }
        
        .btn-load:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            opacity: 0.5;
        }
        
        .sync-status {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.85em;
            font-weight: 500;
        }
        
        .sync-status.disconnected {
            background: #fee;
            color: #c33;
        }
        
        .sync-status.connected {
            background: #efe;
            color: #3c3;
        }
        
        .sync-status.syncing {
            background: #ffc;
            color: #cc6;
        }
        
        .sync-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
        }
    </style>
</head>
<body>
    <div class="container">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
            <h1 style="margin: 0;">📊 매매 기록 통계</h1>
            <div style="display: flex; align-items: center; gap: 15px;">
                <div id="syncStatusContainer" style="display: flex; flex-direction: column; align-items: flex-end; gap: 5px;">
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <div id="syncStatus" class="sync-status disconnected">
                            <span class="sync-dot"></span>
                            <span id="statusText">연결 안됨</span>
                        </div>
                        <button id="backupBtn" class="btn-backup" onclick="manualBackup()" disabled>
                            <span>💾</span>
                            <span>백업</span>
                        </button>
                        <button id="loadBtn" class="btn-load" onclick="manualLoad()" disabled>
                            <span>📥</span>
                            <span>로드</span>
                        </button>
                        <button id="googleBtn" class="btn-google" onclick="handleAuthClick()">
                            <span>🔐</span>
                            <span id="googleBtnText">구글 로그인</span>
                        </button>
                    </div>
                    <div id="lastSyncTime" style="font-size: 0.85em; color: #6c757d;"></div>
                </div>
            </div>
        </div>
        
        <div class="card">
            <h2>💼 종목별 매매 기록</h2>
            
            <div id="stockList"></div>
            
            <button class="btn-add" onclick="addStock()">+ 종목 추가</button>
            
            <div class="action-buttons" style="margin-top: 20px;">
                <button class="btn-calculate" onclick="calculateAll()" style="width: 100%; font-size: 16px; padding: 15px;">📈 전체 계산</button>
                <button class="btn-export" onclick="exportToExcel()">📥 엑셀 다운로드</button>
                <button class="btn-reset" onclick="resetAll()">🔄 초기화</button>
            </div>
        </div>
        
        <div class="card" id="statsCard" style="display: none;">
            <div class="total-stats">
                <h3>🎯 전체 통계</h3>
                <div class="statistics-grid">
                    <div class="stat-card">
                        <div class="stat-title">총 거래 종목</div>
                        <div class="stat-value" id="totalStocks">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-title">총 투자금액</div>
                        <div class="stat-value" id="totalInvest">0원</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-title">총 수익금</div>
                        <div class="stat-value" id="totalProfit">0원</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-title">평균 수익률</div>
                        <div class="stat-value" id="avgReturn">0%</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-title">승률</div>
                        <div class="stat-value" id="winRate">0%</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-title">최고 수익</div>
                        <div class="stat-value" id="maxProfit">0원</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-title">최대 손실</div>
                        <div class="stat-value" id="maxLoss">0원</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-title">최종 자산</div>
                        <div class="stat-value" id="finalAsset">0원</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // ========== 구글 드라이브 API 설정 ==========
        const CLIENT_ID = '574140412573-n0jau2i3uph1v5p3hi9v004m44bnopq8.apps.googleusercontent.com';
        const API_KEY = '';
        const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';
        const SCOPES = 'https://www.googleapis.com/auth/drive.file';
        const FILE_NAME = 'chart_stats_data.json';
        
        let tokenClient;
        let gapiInited = false;
        let gisInited = false;
        let isSignedIn = false;
        let driveFileId = null;
        let tokenRefreshTimer = null; // 토큰 자동 갱신 타이머
        
        // 데이터 저장 (localStorage에서 불러오기)
        let stockData = JSON.parse(localStorage.getItem('chart_stats_data') || '[]');
        
        // 숫자에 쉼표 추가
        function formatNumber(num) {
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        }
        
        // 쉼표 제거하고 숫자로 변환
        function parseNumber(str) {
            return parseFloat(str.replace(/,/g, '')) || 0;
        }
        
        // 날짜 포맷 변환 (251015 -> 25-10-15)
        function formatDate(dateStr) {
            if (dateStr.length !== 6) return '';
            return `${dateStr.substring(0, 2)}-${dateStr.substring(2, 4)}-${dateStr.substring(4, 6)}`;
        }
        
        // 날짜를 Date 객체로 변환 (251015 -> Date)
        function parseDate(dateStr) {
            if (dateStr.length !== 6) return null;
            const year = 2000 + parseInt(dateStr.substring(0, 2));
            const month = parseInt(dateStr.substring(2, 4)) - 1; // 0-based
            const day = parseInt(dateStr.substring(4, 6));
            return new Date(year, month, day);
        }
        
        // 두 날짜 간 차이 계산 (일 단위)
        function getDaysDiff(date1Str, date2Str) {
            const d1 = parseDate(date1Str);
            const d2 = parseDate(date2Str);
            if (!d1 || !d2) return '';
            const diffTime = d2 - d1;
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            return `D+${diffDays}`;
        }
        
        // 입력 필드에 쉼표 자동 추가
        function formatInput(input) {
            const cursorPos = input.selectionStart;
            const oldValue = input.value;
            const oldLength = oldValue.length;
            
            const numValue = oldValue.replace(/,/g, '');
            if (numValue === '') {
                input.value = '';
                return;
            }
            
            const cleanValue = numValue.replace(/[^\d.]/g, '');
            if (cleanValue === '') {
                input.value = '';
                return;
            }
            
            const parts = cleanValue.split('.');
            parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            const formatted = parts.join('.');
            
            input.value = formatted;
            
            try {
                const newLength = formatted.length;
                const diff = newLength - oldLength;
                input.setSelectionRange(cursorPos + diff, cursorPos + diff);
            } catch (e) {}
        }
        
        function addStock() {
            const stockList = document.getElementById('stockList');
            const index = stockList.children.length;
            
            const stockDiv = document.createElement('div');
            stockDiv.className = 'stock-item';
            stockDiv.dataset.index = index;
            
            stockDiv.innerHTML = `
                <div style="display: grid; grid-template-columns: 200px 1fr; gap: 15px; margin-bottom: 15px;">
                    <div>
                        <label>포착일 (예: 251015)</label>
                        <input type="text" class="detect-date" placeholder="251015" maxlength="6" style="width: 100%;">
                        <div style="font-size: 0.85em; color: #666; margin-top: 5px;">
                            포맷: <span class="detect-date-formatted">--</span>
                        </div>
                    </div>
                    <div>
                        <label>종목명</label>
                        <input type="text" class="stock-name" placeholder="예: 삼성전자">
                    </div>
                </div>
                
                <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <h4 style="color: #1976d2; margin-bottom: 10px;">💰 매수 정보</h4>
                    <div class="buy-list">
                        <div class="buy-row" style="display: grid; grid-template-columns: 120px 80px auto 1fr 1fr 1fr auto; gap: 10px; margin-bottom: 10px; align-items: center;">
                            <div>
                                <label style="font-size: 0.85em;">날짜 (251015)</label>
                                <input type="text" class="buy-date" placeholder="251015" maxlength="6">
                            </div>
                            <div>
                                <label style="font-size: 0.85em;">D+일</label>
                                <input type="text" class="buy-dplus" placeholder="D+0" readonly style="background: #f5f5f5;">
                            </div>
                            <div>
                                <label style="font-size: 0.85em;">차수</label>
                                <input type="text" class="buy-order" value="1차 매수" readonly style="background: #f5f5f5;">
                            </div>
                            <div>
                                <label style="font-size: 0.85em;">매수가</label>
                                <input type="text" class="buy-price" placeholder="가격" inputmode="numeric">
                            </div>
                            <div>
                                <label style="font-size: 0.85em;">수량</label>
                                <input type="text" class="buy-quantity" placeholder="수량" inputmode="numeric">
                            </div>
                            <div>
                                <label style="font-size: 0.85em;">금액</label>
                                <input type="text" class="buy-total" placeholder="자동계산" readonly style="background: #f5f5f5;">
                            </div>
                            <div style="display: flex; align-items: flex-end;">
                                <button class="btn-delete-row" onclick="deleteBuyRow(this)" style="display:none; padding: 8px 12px; font-size: 0.9em;">삭제</button>
                            </div>
                        </div>
                    </div>
                    <button class="btn-add-buy" onclick="addBuyRow(this)" style="background: #4caf50; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; width: 100%;">+ 매수 추가</button>
                </div>
                
                <div style="background: #fff3e0; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <h4 style="color: #f57c00; margin-bottom: 10px;">💸 매도 정보 (3분할 자동: 30%, 35%, 잔량)</h4>
                    
                    <div style="display: grid; grid-template-columns: 120px 80px auto 1fr 1fr 1fr; gap: 10px; margin-bottom: 10px; align-items: center;">
                        <div>
                            <label style="font-size: 0.85em;">날짜 (251015)</label>
                            <input type="text" class="sell1-date" placeholder="251015" maxlength="6">
                        </div>
                        <div>
                            <label style="font-size: 0.85em;">D+일</label>
                            <input type="text" class="sell1-dplus" placeholder="D+0" readonly style="background: #f5f5f5;">
                        </div>
                        <div>
                            <label style="font-size: 0.85em;">차수</label>
                            <input type="text" value="1차 매도 (30%)" readonly style="background: #f5f5f5;">
                        </div>
                        <div>
                            <label style="font-size: 0.85em;">매도가</label>
                            <input type="text" class="sell1-price" placeholder="매도가" inputmode="numeric">
                        </div>
                        <div>
                            <label style="font-size: 0.85em;">수량</label>
                            <input type="text" class="sell1-quantity" placeholder="자동계산" readonly style="background: #f5f5f5;">
                        </div>
                        <div>
                            <label style="font-size: 0.85em;">금액</label>
                            <input type="text" class="sell1-total" placeholder="자동계산" readonly style="background: #f5f5f5;">
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 120px 80px auto 1fr 1fr 1fr; gap: 10px; margin-bottom: 10px; align-items: center;">
                        <div>
                            <label style="font-size: 0.85em;">날짜 (251015)</label>
                            <input type="text" class="sell2-date" placeholder="251015" maxlength="6">
                        </div>
                        <div>
                            <label style="font-size: 0.85em;">D+일</label>
                            <input type="text" class="sell2-dplus" placeholder="D+0" readonly style="background: #f5f5f5;">
                        </div>
                        <div>
                            <label style="font-size: 0.85em;">차수</label>
                            <input type="text" value="2차 매도 (35%)" readonly style="background: #f5f5f5;">
                        </div>
                        <div>
                            <label style="font-size: 0.85em;">매도가</label>
                            <input type="text" class="sell2-price" placeholder="매도가" inputmode="numeric">
                        </div>
                        <div>
                            <label style="font-size: 0.85em;">수량</label>
                            <input type="text" class="sell2-quantity" placeholder="자동계산" readonly style="background: #f5f5f5;">
                        </div>
                        <div>
                            <label style="font-size: 0.85em;">금액</label>
                            <input type="text" class="sell2-total" placeholder="자동계산" readonly style="background: #f5f5f5;">
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 120px 80px auto 1fr 1fr 1fr; gap: 10px; margin-bottom: 10px; align-items: center;">
                        <div>
                            <label style="font-size: 0.85em;">날짜 (251015)</label>
                            <input type="text" class="sell3-date" placeholder="251015" maxlength="6">
                        </div>
                        <div>
                            <label style="font-size: 0.85em;">D+일</label>
                            <input type="text" class="sell3-dplus" placeholder="D+0" readonly style="background: #f5f5f5;">
                        </div>
                        <div>
                            <label style="font-size: 0.85em;">차수</label>
                            <input type="text" value="3차 매도 (잔량)" readonly style="background: #f5f5f5;">
                        </div>
                        <div>
                            <label style="font-size: 0.85em;">매도가</label>
                            <input type="text" class="sell3-price" placeholder="매도가" inputmode="numeric">
                        </div>
                        <div>
                            <label style="font-size: 0.85em;">수량</label>
                            <input type="text" class="sell3-quantity" placeholder="자동계산" readonly style="background: #f5f5f5;">
                        </div>
                        <div>
                            <label style="font-size: 0.85em;">금액</label>
                            <input type="text" class="sell3-total" placeholder="자동계산" readonly style="background: #f5f5f5;">
                        </div>
                    </div>
                </div>
                
                <div style="text-align: right;">
                    <button class="btn-delete" onclick="deleteStock(this)">삭제</button>
                </div>
                
                <div class="stock-result" style="display: none;">
                    <div class="result-box">
                        <div class="result-label">총 매수금액</div>
                        <div class="result-value buy-amount">0원</div>
                    </div>
                    <div class="result-box">
                        <div class="result-label">총 매도금액</div>
                        <div class="result-value sell-amount">0원</div>
                    </div>
                    <div class="result-box">
                        <div class="result-label">평단가</div>
                        <div class="result-value avg-price">0원</div>
                    </div>
                    <div class="result-box">
                        <div class="result-label">총 수익금</div>
                        <div class="result-value profit-amount">0원</div>
                    </div>
                    <div class="result-box">
                        <div class="result-label">평균 수익률</div>
                        <div class="result-value profit-rate">0%</div>
                    </div>
                    <div class="result-box">
                        <div class="result-label">보유수량</div>
                        <div class="result-value remaining-qty">0주</div>
                    </div>
                </div>
            `;
            
            stockList.appendChild(stockDiv);
            
            // 포착일 이벤트 리스너
            const detectDateInput = stockDiv.querySelector('.detect-date');
            detectDateInput.addEventListener('input', function() {
                const formatted = formatDate(this.value);
                stockDiv.querySelector('.detect-date-formatted').textContent = formatted || '--';
                updateBuyDplus(stockDiv);
            });
            
            // 이벤트 리스너 추가 - 매수
            const buyInputs = stockDiv.querySelectorAll('.buy-row input[inputmode="numeric"]');
            buyInputs.forEach(input => {
                input.addEventListener('input', function() {
                    formatInput(this);
                    calculateBuySellTotals(stockDiv);
                });
            });
            
            // 매수 날짜 이벤트 리스너
            const buyDateInputs = stockDiv.querySelectorAll('.buy-date');
            buyDateInputs.forEach(input => {
                input.addEventListener('input', function() {
                    updateBuyDplus(stockDiv);
                    updateSellDplus(stockDiv);
                });
            });
            
            // 이벤트 리스너 추가 - 매도가
            const sellPriceInputs = stockDiv.querySelectorAll('.sell1-price, .sell2-price, .sell3-price');
            sellPriceInputs.forEach(input => {
                input.addEventListener('input', function() {
                    formatInput(this);
                    calculateBuySellTotals(stockDiv);
                });
            });
            
            // 매도 날짜 이벤트 리스너
            const sellDateInputs = stockDiv.querySelectorAll('.sell1-date, .sell2-date, .sell3-date');
            sellDateInputs.forEach(input => {
                input.addEventListener('input', function() {
                    updateSellDplus(stockDiv);
                });
            });
        }
        
        // 매수 D+ 업데이트
        function updateBuyDplus(stockDiv) {
            const detectDate = stockDiv.querySelector('.detect-date').value;
            const buyRows = stockDiv.querySelectorAll('.buy-row');
            
            buyRows.forEach(row => {
                const buyDate = row.querySelector('.buy-date').value;
                const dplusInput = row.querySelector('.buy-dplus');
                if (detectDate && buyDate) {
                    dplusInput.value = getDaysDiff(detectDate, buyDate);
                } else {
                    dplusInput.value = '';
                }
            });
        }
        
        // 매도 D+ 업데이트
        function updateSellDplus(stockDiv) {
            // 첫 번째 매수 날짜를 기준으로
            const firstBuyDate = stockDiv.querySelector('.buy-date').value;
            
            for (let i = 1; i <= 3; i++) {
                const sellDate = stockDiv.querySelector(`.sell${i}-date`).value;
                const dplusInput = stockDiv.querySelector(`.sell${i}-dplus`);
                if (firstBuyDate && sellDate) {
                    dplusInput.value = getDaysDiff(firstBuyDate, sellDate);
                } else {
                    dplusInput.value = '';
                }
            }
        }
        
        // 매수 행 추가
        function addBuyRow(button) {
            const stockDiv = button.closest('.stock-item');
            const buyList = stockDiv.querySelector('.buy-list');
            const currentRows = buyList.querySelectorAll('.buy-row').length;
            
            const newRow = document.createElement('div');
            newRow.className = 'buy-row';
            newRow.style.cssText = 'display: grid; grid-template-columns: 120px 80px auto 1fr 1fr 1fr auto; gap: 10px; margin-bottom: 10px; align-items: center;';
            newRow.innerHTML = `
                <div>
                    <label style="font-size: 0.85em;">날짜 (251015)</label>
                    <input type="text" class="buy-date" placeholder="251015" maxlength="6">
                </div>
                <div>
                    <label style="font-size: 0.85em;">D+일</label>
                    <input type="text" class="buy-dplus" placeholder="D+0" readonly style="background: #f5f5f5;">
                </div>
                <div>
                    <label style="font-size: 0.85em;">차수</label>
                    <input type="text" class="buy-order" value="${currentRows + 1}차 매수" readonly style="background: #f5f5f5;">
                </div>
                <div>
                    <label style="font-size: 0.85em;">매수가</label>
                    <input type="text" class="buy-price" placeholder="가격" inputmode="numeric">
                </div>
                <div>
                    <label style="font-size: 0.85em;">수량</label>
                    <input type="text" class="buy-quantity" placeholder="수량" inputmode="numeric">
                </div>
                <div>
                    <label style="font-size: 0.85em;">금액</label>
                    <input type="text" class="buy-total" placeholder="자동계산" readonly style="background: #f5f5f5;">
                </div>
                <div style="display: flex; align-items: flex-end;">
                    <button class="btn-delete-row" onclick="deleteBuyRow(this)" style="padding: 8px 12px; font-size: 0.9em;">삭제</button>
                </div>
            `;
            
            buyList.appendChild(newRow);
            
            // 이벤트 리스너 추가 - 숫자 입력
            const inputs = newRow.querySelectorAll('input[inputmode="numeric"]');
            inputs.forEach(input => {
                input.addEventListener('input', function() {
                    formatInput(this);
                    calculateBuySellTotals(stockDiv);
                });
            });
            
            // 날짜 이벤트 리스너
            const dateInput = newRow.querySelector('.buy-date');
            dateInput.addEventListener('input', function() {
                updateBuyDplus(stockDiv);
                updateSellDplus(stockDiv);
            });
            
            // 첫 번째 행의 삭제 버튼 표시
            const firstDelete = buyList.querySelector('.btn-delete-row');
            if (firstDelete) {
                firstDelete.style.display = 'block';
            }
        }
        
        // 매수 행 삭제
        function deleteBuyRow(button) {
            const stockDiv = button.closest('.stock-item');
            const buyList = stockDiv.querySelector('.buy-list');
            button.closest('.buy-row').remove();
            
            // 행이 1개만 남으면 삭제 버튼 숨김
            const rows = buyList.querySelectorAll('.buy-row');
            if (rows.length === 1) {
                const deleteBtn = rows[0].querySelector('.btn-delete-row');
                if (deleteBtn) deleteBtn.style.display = 'none';
            }
            
            // 차수 재계산
            rows.forEach((row, index) => {
                row.querySelector('.buy-order').value = `${index + 1}차 매수`;
            });
            
            calculateBuySellTotals(stockDiv);
            updateSellDplus(stockDiv);
        }
        
        // 매수/매도 금액 자동 계산
        function calculateBuySellTotals(stockDiv) {
            // 매수 계산
            const buyRows = stockDiv.querySelectorAll('.buy-row');
            let totalBuyQty = 0;
            
            buyRows.forEach(row => {
                const price = parseNumber(row.querySelector('.buy-price').value);
                const quantity = parseNumber(row.querySelector('.buy-quantity').value);
                const total = price * quantity;
                row.querySelector('.buy-total').value = total > 0 ? formatNumber(Math.round(total)) : '';
                totalBuyQty += quantity;
            });
            
            // 매도 계산 (1차: 30%, 2차: 35%, 3차: 잔량 전부)
            const sell1Qty = Math.floor(totalBuyQty * 0.3);
            const sell2Qty = Math.floor(totalBuyQty * 0.35);
            const sell3Qty = totalBuyQty - sell1Qty - sell2Qty; // 잔량 전부
            
            const quantities = [sell1Qty, sell2Qty, sell3Qty];
            
            for (let i = 1; i <= 3; i++) {
                const priceInput = stockDiv.querySelector(`.sell${i}-price`);
                const qtyInput = stockDiv.querySelector(`.sell${i}-quantity`);
                const totalInput = stockDiv.querySelector(`.sell${i}-total`);
                
                const price = parseNumber(priceInput.value);
                const quantity = quantities[i-1];
                const total = price * quantity;
                
                qtyInput.value = quantity > 0 ? formatNumber(quantity) : '';
                totalInput.value = total > 0 ? formatNumber(Math.round(total)) : '';
            }
        }
        
        function deleteStock(button) {
            button.closest('.stock-item').remove();
            saveToLocalStorage();
            saveToGoogleDrive();
        }
        
        function calculateAll() {
            const stockItems = document.querySelectorAll('.stock-item');
            stockData = [];
            
            let totalInvest = 0;
            let totalProfit = 0;
            let winCount = 0;
            let maxProfit = 0;
            let maxLoss = 0;
            
            stockItems.forEach((item, index) => {
                const name = item.querySelector('.stock-name').value || `종목${index + 1}`;
                const detectDate = item.querySelector('.detect-date').value;
                const detectDateFormatted = formatDate(detectDate);
                
                // 매수 정보 수집
                let totalBuyAmount = 0;
                let totalBuyQty = 0;
                const buyData = [];
                
                const buyRows = item.querySelectorAll('.buy-row');
                buyRows.forEach((row, idx) => {
                    const date = row.querySelector('.buy-date').value;
                    const dateFormatted = formatDate(date);
                    const dplus = row.querySelector('.buy-dplus').value;
                    const price = parseNumber(row.querySelector('.buy-price').value);
                    const qty = parseNumber(row.querySelector('.buy-quantity').value);
                    if (price > 0 && qty > 0) {
                        totalBuyAmount += price * qty;
                        totalBuyQty += qty;
                        buyData.push({ 
                            order: `${idx + 1}차`,
                            date: dateFormatted,
                            dplus: dplus,
                            price, 
                            qty, 
                            amount: price * qty 
                        });
                    }
                });
                
                // 매도 정보 수집 (1차: 30%, 2차: 35%, 3차: 잔량 전부)
                let totalSellAmount = 0;
                let totalSellQty = 0;
                const sellData = [];
                
                const sell1Qty = Math.floor(totalBuyQty * 0.3);
                const sell2Qty = Math.floor(totalBuyQty * 0.35);
                const sell3Qty = totalBuyQty - sell1Qty - sell2Qty; // 잔량 전부
                const quantities = [sell1Qty, sell2Qty, sell3Qty];
                const ratios = [0.3, 0.35, null]; // 3차는 잔량
                
                for (let i = 1; i <= 3; i++) {
                    const date = item.querySelector(`.sell${i}-date`).value;
                    const dateFormatted = formatDate(date);
                    const dplus = item.querySelector(`.sell${i}-dplus`).value;
                    const price = parseNumber(item.querySelector(`.sell${i}-price`).value);
                    const qty = quantities[i-1];
                    
                    if (price > 0 && qty > 0) {
                        totalSellAmount += price * qty;
                        totalSellQty += qty;
                        sellData.push({ 
                            order: `${i}차`,
                            date: dateFormatted,
                            dplus: dplus,
                            price, 
                            qty, 
                            amount: price * qty, 
                            ratio: ratios[i-1],
                            description: i === 3 ? '잔량' : `${(ratios[i-1] * 100).toFixed(0)}%`
                        });
                    }
                }
                
                if (totalBuyQty > 0) {
                    const avgPrice = totalBuyAmount / totalBuyQty;
                    const profit = totalSellAmount - (avgPrice * totalSellQty);
                    const profitRate = totalSellQty > 0 ? (profit / (avgPrice * totalSellQty) * 100) : 0;
                    const remainingQty = totalBuyQty - totalSellQty;
                    
                    totalInvest += totalBuyAmount;
                    totalProfit += profit;
                    
                    if (profit > 0) {
                        winCount++;
                    }
                    
                    if (profit > maxProfit) {
                        maxProfit = profit;
                    }
                    
                    if (profit < maxLoss) {
                        maxLoss = profit;
                    }
                    
                    // 결과 표시
                    const resultDiv = item.querySelector('.stock-result');
                    resultDiv.style.display = 'grid';
                    
                    resultDiv.querySelector('.buy-amount').textContent = Math.round(totalBuyAmount).toLocaleString('ko-KR') + '원';
                    resultDiv.querySelector('.sell-amount').textContent = Math.round(totalSellAmount).toLocaleString('ko-KR') + '원';
                    resultDiv.querySelector('.avg-price').textContent = Math.round(avgPrice).toLocaleString('ko-KR') + '원';
                    resultDiv.querySelector('.profit-amount').textContent = Math.round(profit).toLocaleString('ko-KR') + '원';
                    resultDiv.querySelector('.profit-rate').textContent = profitRate.toFixed(2) + '%';
                    resultDiv.querySelector('.remaining-qty').textContent = remainingQty.toLocaleString('ko-KR') + '주';
                    
                    // 수익/손실 색상
                    const profitElement = resultDiv.querySelector('.profit-amount');
                    const rateElement = resultDiv.querySelector('.profit-rate');
                    if (profit >= 0) {
                        profitElement.className = 'result-value profit';
                        rateElement.className = 'result-value profit';
                    } else {
                        profitElement.className = 'result-value loss';
                        rateElement.className = 'result-value loss';
                    }
                    
                    // 데이터 저장 (엑셀용)
                    const stockRecord = {
                        종목명: name,
                        포착일: detectDateFormatted,
                        평단가: avgPrice,
                        총매수수량: totalBuyQty,
                        총매수금액: totalBuyAmount,
                        총매도수량: totalSellQty,
                        총매도금액: totalSellAmount,
                        수익금: profit,
                        수익률: profitRate,
                        보유수량: remainingQty,
                        매수내역: buyData,
                        매도내역: sellData
                    };
                    
                    stockData.push(stockRecord);
                }
            });
            
            // 전체 통계 표시
            if (stockData.length > 0) {
                const avgReturn = (totalProfit / totalInvest * 100);
                const winRate = (winCount / stockData.length * 100);
                const finalAsset = totalInvest + totalProfit;
                
                document.getElementById('totalStocks').textContent = stockData.length;
                document.getElementById('totalInvest').textContent = Math.round(totalInvest).toLocaleString('ko-KR') + '원';
                document.getElementById('totalProfit').textContent = Math.round(totalProfit).toLocaleString('ko-KR') + '원';
                document.getElementById('avgReturn').textContent = avgReturn.toFixed(2) + '%';
                document.getElementById('winRate').textContent = winRate.toFixed(1) + '%';
                document.getElementById('maxProfit').textContent = Math.round(maxProfit).toLocaleString('ko-KR') + '원';
                document.getElementById('maxLoss').textContent = Math.round(maxLoss).toLocaleString('ko-KR') + '원';
                document.getElementById('finalAsset').textContent = Math.round(finalAsset).toLocaleString('ko-KR') + '원';
                
                // 수익/손실 색상
                const profitEl = document.getElementById('totalProfit');
                const returnEl = document.getElementById('avgReturn');
                if (totalProfit >= 0) {
                    profitEl.style.color = '#f44336';
                    returnEl.style.color = '#f44336';
                } else {
                    profitEl.style.color = '#2196f3';
                    returnEl.style.color = '#2196f3';
                }
                
                document.getElementById('statsCard').style.display = 'block';
            } else {
                alert('입력된 데이터가 없습니다!');
            }
            
            // 데이터 저장
            saveToLocalStorage();
            saveToGoogleDrive();
        }
        
        function exportToExcel() {
            if (stockData.length === 0) {
                alert('먼저 계산을 해주세요!');
                return;
            }
            
            // 엑셀 데이터 준비 - 각 종목별로 시트 생성
            const wb = XLSX.utils.book_new();
            
            // 종목별 상세 시트
            stockData.forEach((stock, idx) => {
                const ws_data = [
                    ['종목명', stock.종목명],
                    ['포착일', stock.포착일],
                    [],
                    ['=== 매수 내역 ==='],
                    ['차수', '날짜', 'D+일', '매수가', '수량', '금액']
                ];
                
                stock.매수내역.forEach((buy) => {
                    ws_data.push([buy.order, buy.date, buy.dplus, buy.price, buy.qty, buy.amount]);
                });
                
                ws_data.push([]);
                ws_data.push(['총 매수수량', stock.총매수수량]);
                ws_data.push(['총 매수금액', Math.round(stock.총매수금액)]);
                ws_data.push(['평단가', Math.round(stock.평단가)]);
                
                ws_data.push([]);
                ws_data.push(['=== 매도 내역 ===']);
                ws_data.push(['차수', '날짜', 'D+일', '매도가', '수량', '금액', '비율']);
                
                stock.매도내역.forEach((sell) => {
                    ws_data.push([sell.order, sell.date, sell.dplus, sell.price, sell.qty, sell.amount, sell.description]);
                });
                
                ws_data.push([]);
                ws_data.push(['총 매도수량', stock.총매도수량]);
                ws_data.push(['총 매도금액', Math.round(stock.총매도금액)]);
                
                ws_data.push([]);
                ws_data.push(['=== 수익 결과 ===']);
                ws_data.push(['수익금', Math.round(stock.수익금)]);
                ws_data.push(['수익률(%)', stock.수익률.toFixed(2)]);
                ws_data.push(['보유수량', stock.보유수량]);
                
                const ws = XLSX.utils.aoa_to_sheet(ws_data);
                ws['!cols'] = [{wch: 12}, {wch: 12}, {wch: 10}, {wch: 12}, {wch: 12}, {wch: 15}, {wch: 10}];
                
                XLSX.utils.book_append_sheet(wb, ws, `${stock.종목명.substring(0, 10)}_${idx+1}`);
            });
            
            // 전체 요약 시트
            const summary_data = [
                ['종목명', '포착일', '평단가', '총매수수량', '총매수금액', '총매도수량', '총매도금액', '수익금', '수익률(%)', '보유수량']
            ];
            
            stockData.forEach(stock => {
                summary_data.push([
                    stock.종목명,
                    stock.포착일,
                    Math.round(stock.평단가),
                    stock.총매수수량,
                    Math.round(stock.총매수금액),
                    stock.총매도수량,
                    Math.round(stock.총매도금액),
                    Math.round(stock.수익금),
                    stock.수익률.toFixed(2),
                    stock.보유수량
                ]);
            });
            
            // 통계 추가
            summary_data.push([]);
            summary_data.push(['=== 전체 통계 ===']);
            summary_data.push(['총 거래 종목', stockData.length]);
            
            let totalInvest = 0;
            let totalProfit = 0;
            let winCount = 0;
            let maxProfit = 0;
            let maxLoss = 0;
            
            stockData.forEach(stock => {
                totalInvest += stock.총매수금액;
                totalProfit += stock.수익금;
                if (stock.수익금 > 0) winCount++;
                if (stock.수익금 > maxProfit) maxProfit = stock.수익금;
                if (stock.수익금 < maxLoss) maxLoss = stock.수익금;
            });
            
            summary_data.push(['총 투자금액', Math.round(totalInvest)]);
            summary_data.push(['총 수익금', Math.round(totalProfit)]);
            summary_data.push(['평균 수익률(%)', (totalProfit / totalInvest * 100).toFixed(2)]);
            summary_data.push(['승률(%)', (winCount / stockData.length * 100).toFixed(1)]);
            summary_data.push(['최고 수익', Math.round(maxProfit)]);
            summary_data.push(['최대 손실', Math.round(maxLoss)]);
            summary_data.push(['최종 자산', Math.round(totalInvest + totalProfit)]);
            
            const ws_summary = XLSX.utils.aoa_to_sheet(summary_data);
            ws_summary['!cols'] = [
                {wch: 15}, {wch: 12}, {wch: 12}, {wch: 12}, {wch: 15},
                {wch: 12}, {wch: 15}, {wch: 15}, {wch: 12}, {wch: 12}
            ];
            
            XLSX.utils.book_append_sheet(wb, ws_summary, '전체요약', true);
            // 전체요약 시트를 맨 앞으로 이동
            wb.SheetNames.unshift(wb.SheetNames.pop());
            
            // 파일 다운로드
            const today = new Date();
            const dateStr = today.getFullYear() + 
                           String(today.getMonth() + 1).padStart(2, '0') + 
                           String(today.getDate()).padStart(2, '0');
            const filename = `매매기록_${dateStr}.xlsx`;
            
            XLSX.writeFile(wb, filename);
        }
        
        function resetAll() {
            if (confirm('모든 데이터를 초기화하시겠습니까?')) {
                document.getElementById('stockList').innerHTML = '';
                document.getElementById('statsCard').style.display = 'none';
                stockData = [];
                saveToLocalStorage();
                saveToGoogleDrive();
            }
        }
        
        // ========== 로컬스토리지 저장 ==========
        function saveToLocalStorage() {
            // DOM의 모든 입력값을 수집
            const stockItems = document.querySelectorAll('.stock-item');
            const inputData = [];
            
            stockItems.forEach(item => {
                const stockInfo = {
                    detectDate: item.querySelector('.detect-date').value,
                    stockName: item.querySelector('.stock-name').value,
                    buyRows: [],
                    sell1Date: item.querySelector('.sell1-date').value,
                    sell1Price: item.querySelector('.sell1-price').value,
                    sell2Date: item.querySelector('.sell2-date').value,
                    sell2Price: item.querySelector('.sell2-price').value,
                    sell3Date: item.querySelector('.sell3-date').value,
                    sell3Price: item.querySelector('.sell3-price').value
                };
                
                // 매수 정보 수집
                const buyRows = item.querySelectorAll('.buy-row');
                buyRows.forEach(row => {
                    stockInfo.buyRows.push({
                        date: row.querySelector('.buy-date').value,
                        price: row.querySelector('.buy-price').value,
                        quantity: row.querySelector('.buy-quantity').value
                    });
                });
                
                inputData.push(stockInfo);
            });
            
            localStorage.setItem('chart_stats_input_data', JSON.stringify(inputData));
            localStorage.setItem('chart_stats_data', JSON.stringify(stockData));
        }
        
        // ========== 구글 API 초기화 ==========
        function gapiLoaded() {
            gapi.load('client', initializeGapiClient);
        }

        async function initializeGapiClient() {
            await gapi.client.init({
                apiKey: API_KEY,
                discoveryDocs: [DISCOVERY_DOC],
            });
            gapiInited = true;
            maybeEnableButtons();
        }

        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: '',
            });
            gisInited = true;
            maybeEnableButtons();
        }

        function maybeEnableButtons() {
            if (gapiInited && gisInited) {
                document.getElementById('googleBtn').disabled = false;
            }
        }

        function handleAuthClick() {
            if (isSignedIn) {
                handleSignoutClick();
            } else {
                tokenClient.callback = async (resp) => {
                    if (resp.error !== undefined) {
                        throw (resp);
                    }
                    
                    // 토큰을 localStorage에 저장
                    localStorage.setItem('google_access_token_chartstats', resp.access_token);
                    if (resp.expires_in) {
                        const expiryTime = Date.now() + (resp.expires_in * 1000);
                        localStorage.setItem('google_token_expiry_chartstats', expiryTime.toString());
                        
                        // 토큰 자동 갱신 타이머 설정 (만료 5분 전에 갱신)
                        setupTokenRefresh(resp.expires_in);
                    }
                    
                    isSignedIn = true;
                    updateSyncStatus('connected', '연결됨');
                    document.getElementById('googleBtnText').textContent = '로그아웃';
                    document.getElementById('backupBtn').disabled = false;
                    document.getElementById('loadBtn').disabled = false;
                    await loadFromGoogleDrive();
                };

                if (gapi.client.getToken() === null) {
                    tokenClient.requestAccessToken({prompt: 'consent'});
                } else {
                    tokenClient.requestAccessToken({prompt: ''});
                }
            }
        }

        function handleSignoutClick() {
            const token = gapi.client.getToken();
            if (token !== null) {
                google.accounts.oauth2.revoke(token.access_token);
                gapi.client.setToken('');
            }
            
            // 토큰 갱신 타이머 정리
            if (tokenRefreshTimer) {
                clearTimeout(tokenRefreshTimer);
                tokenRefreshTimer = null;
            }
            
            // localStorage에서 토큰 삭제
            localStorage.removeItem('google_access_token_chartstats');
            localStorage.removeItem('google_token_expiry_chartstats');
            
            isSignedIn = false;
            updateSyncStatus('disconnected', '연결 안됨');
            document.getElementById('googleBtnText').textContent = '구글 로그인';
            document.getElementById('lastSyncTime').textContent = '';
            document.getElementById('backupBtn').disabled = true;
            document.getElementById('loadBtn').disabled = true;
        }

        // ========== 저장된 토큰으로 로그인 복원 ==========
        async function restoreLoginState() {
            const savedToken = localStorage.getItem('google_access_token_chartstats');
            const tokenExpiry = localStorage.getItem('google_token_expiry_chartstats');
            
            if (savedToken && tokenExpiry) {
                if (Date.now() < parseInt(tokenExpiry)) {
                    gapi.client.setToken({
                        access_token: savedToken
                    });
                    
                    isSignedIn = true;
                    updateSyncStatus('connected', '연결됨');
                    document.getElementById('googleBtnText').textContent = '로그아웃';
                    document.getElementById('backupBtn').disabled = false;
                    document.getElementById('loadBtn').disabled = false;
                    
                    // 남은 시간 계산하여 토큰 자동 갱신 타이머 설정
                    const remainingSeconds = Math.floor((parseInt(tokenExpiry) - Date.now()) / 1000);
                    setupTokenRefresh(remainingSeconds);
                    
                    await loadFromGoogleDrive();
                } else {
                    localStorage.removeItem('google_access_token_chartstats');
                    localStorage.removeItem('google_token_expiry_chartstats');
                }
            }
        }

        // ========== 토큰 자동 갱신 설정 ==========
        function setupTokenRefresh(expiresInSeconds) {
            // 기존 타이머가 있으면 제거
            if (tokenRefreshTimer) {
                clearTimeout(tokenRefreshTimer);
            }
            
            // 만료 5분 전에 갱신 (최소 1분 전)
            const refreshTime = Math.max((expiresInSeconds - 300) * 1000, 60 * 1000);
            
            tokenRefreshTimer = setTimeout(async () => {
                if (isSignedIn && tokenClient) {
                    try {
                        // 팝업 없이 자동 갱신 시도
                        tokenClient.callback = async (resp) => {
                            if (resp.error === undefined) {
                                // 토큰을 localStorage에 저장
                                localStorage.setItem('google_access_token_chartstats', resp.access_token);
                                if (resp.expires_in) {
                                    const expiryTime = Date.now() + (resp.expires_in * 1000);
                                    localStorage.setItem('google_token_expiry_chartstats', expiryTime.toString());
                                    
                                    // 다시 타이머 설정
                                    setupTokenRefresh(resp.expires_in);
                                }
                                
                                gapi.client.setToken({
                                    access_token: resp.access_token
                                });
                                
                                console.log('토큰이 자동으로 갱신되었습니다.');
                            }
                        };
                        
                        tokenClient.requestAccessToken({prompt: ''});
                    } catch (err) {
                        console.error('토큰 자동 갱신 실패:', err);
                    }
                }
            }, refreshTime);
        }

        function updateSyncStatus(status, text) {
            const statusEl = document.getElementById('syncStatus');
            const textEl = document.getElementById('statusText');
            if (statusEl && textEl) {
                statusEl.className = `sync-status ${status}`;
                textEl.textContent = text;
            }
        }

        function updateLastSyncTime() {
            const now = new Date();
            const timeStr = now.toLocaleString('ko-KR', { 
                month: '2-digit', 
                day: '2-digit', 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            document.getElementById('lastSyncTime').textContent = `마지막 동기화: ${timeStr}`;
        }

        // ========== 구글 드라이브 파일 찾기 ==========
        async function findDriveFile() {
            try {
                const response = await gapi.client.drive.files.list({
                    q: `name='${FILE_NAME}' and trashed=false`,
                    spaces: 'drive',
                    fields: 'files(id, name)',
                });
                const files = response.result.files;
                if (files && files.length > 0) {
                    return files[0].id;
                }
                return null;
            } catch (err) {
                console.error('파일 검색 오류:', err);
                return null;
            }
        }

        // ========== 구글 드라이브에서 불러오기 ==========
        async function loadFromGoogleDrive() {
            if (!isSignedIn) return;
            
            updateSyncStatus('syncing', '불러오는 중...');
            
            try {
                driveFileId = await findDriveFile();
                
                if (driveFileId) {
                    const response = await gapi.client.drive.files.get({
                        fileId: driveFileId,
                        alt: 'media',
                    });
                    
                    const data = JSON.parse(response.body);
                    localStorage.setItem('chart_stats_input_data', JSON.stringify(data));
                    
                    // UI 업데이트
                    restoreFromInputData(data);
                    
                    updateSyncStatus('connected', '연결됨');
                    updateLastSyncTime();
                } else {
                    updateSyncStatus('connected', '연결됨 (파일 없음)');
                }
            } catch (err) {
                console.error('불러오기 오류:', err);
                updateSyncStatus('connected', '연결됨');
            }
        }

        // ========== 구글 드라이브에 저장 ==========
        async function saveToGoogleDrive() {
            if (!isSignedIn) return;
            
            updateSyncStatus('syncing', '저장 중...');
            
            try {
                // 입력 데이터 가져오기
                const inputData = JSON.parse(localStorage.getItem('chart_stats_input_data') || '[]');
                const data = JSON.stringify(inputData, null, 2);
                const blob = new Blob([data], { type: 'application/json' });
                
                if (driveFileId) {
                    const metadata = {
                        name: FILE_NAME,
                        mimeType: 'application/json',
                    };
                    
                    const form = new FormData();
                    form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                    form.append('file', blob);
                    
                    await fetch(`https://www.googleapis.com/upload/drive/v3/files/${driveFileId}?uploadType=multipart`, {
                        method: 'PATCH',
                        headers: new Headers({ 'Authorization': 'Bearer ' + gapi.client.getToken().access_token }),
                        body: form,
                    });
                } else {
                    const metadata = {
                        name: FILE_NAME,
                        mimeType: 'application/json',
                    };
                    
                    const form = new FormData();
                    form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                    form.append('file', blob);
                    
                    const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                        method: 'POST',
                        headers: new Headers({ 'Authorization': 'Bearer ' + gapi.client.getToken().access_token }),
                        body: form,
                    });
                    
                    const result = await response.json();
                    driveFileId = result.id;
                }
                
                updateSyncStatus('connected', '연결됨');
                updateLastSyncTime();
            } catch (err) {
                console.error('저장 오류:', err);
                updateSyncStatus('connected', '연결됨 (저장 실패)');
            }
        }

        // ========== 수동 백업 ==========
        async function manualBackup() {
            if (!isSignedIn) {
                alert('구글 로그인이 필요합니다.');
                return;
            }
            
            if (confirm('현재 데이터를 구글 드라이브에 백업하시겠습니까?')) {
                await saveToGoogleDrive();
                alert('백업이 완료되었습니다!');
            }
        }

        // ========== 수동 불러오기 ==========
        async function manualLoad() {
            if (!isSignedIn) {
                alert('구글 로그인이 필요합니다.');
                return;
            }
            
            if (confirm('구글 드라이브에서 데이터를 로드하시겠습니까?\n현재 데이터는 덮어씌워집니다.')) {
                await loadFromGoogleDrive();
                alert('데이터를 로드했습니다!');
            }
        }

        // ========== 모든 종목 렌더링 ==========
        function renderAllStocks() {
            const inputData = JSON.parse(localStorage.getItem('chart_stats_input_data') || '[]');
            if (inputData.length > 0) {
                restoreFromInputData(inputData);
            }
        }
        
        // ========== 입력 데이터에서 DOM 복원 ==========
        function restoreFromInputData(inputData) {
            const container = document.getElementById('stockList');
            container.innerHTML = '';
            
            if (inputData.length === 0) {
                addStock();
                return;
            }
            
            inputData.forEach(stockInfo => {
                addStock();
                const stockItems = document.querySelectorAll('.stock-item');
                const lastItem = stockItems[stockItems.length - 1];
                
                // 기본 정보 복원
                lastItem.querySelector('.detect-date').value = stockInfo.detectDate || '';
                lastItem.querySelector('.stock-name').value = stockInfo.stockName || '';
                
                // 포착일 포맷 표시
                const formatted = formatDate(stockInfo.detectDate);
                lastItem.querySelector('.detect-date-formatted').textContent = formatted || '--';
                
                // 매수 정보 복원
                const buyList = lastItem.querySelector('.buy-list');
                const existingBuyRows = buyList.querySelectorAll('.buy-row');
                
                // 첫 번째 행 업데이트
                if (stockInfo.buyRows.length > 0 && existingBuyRows.length > 0) {
                    const firstRow = existingBuyRows[0];
                    firstRow.querySelector('.buy-date').value = stockInfo.buyRows[0].date || '';
                    firstRow.querySelector('.buy-price').value = stockInfo.buyRows[0].price || '';
                    firstRow.querySelector('.buy-quantity').value = stockInfo.buyRows[0].quantity || '';
                    
                    // D+일 자동 계산
                    updateBuyDplus(lastItem);
                    
                    // 금액 자동 계산
                    const price = parseNumber(stockInfo.buyRows[0].price);
                    const qty = parseNumber(stockInfo.buyRows[0].quantity);
                    if (price > 0 && qty > 0) {
                        firstRow.querySelector('.buy-total').value = formatNumber(Math.round(price * qty));
                    }
                }
                
                // 추가 매수 행들
                for (let i = 1; i < stockInfo.buyRows.length; i++) {
                    const addBtn = lastItem.querySelector('.btn-add-buy');
                    addBuyRow(addBtn);
                    
                    const rows = lastItem.querySelectorAll('.buy-row');
                    const newRow = rows[i];
                    newRow.querySelector('.buy-date').value = stockInfo.buyRows[i].date || '';
                    newRow.querySelector('.buy-price').value = stockInfo.buyRows[i].price || '';
                    newRow.querySelector('.buy-quantity').value = stockInfo.buyRows[i].quantity || '';
                    
                    // D+일 자동 계산
                    updateBuyDplus(lastItem);
                    
                    // 금액 자동 계산
                    const price = parseNumber(stockInfo.buyRows[i].price);
                    const qty = parseNumber(stockInfo.buyRows[i].quantity);
                    if (price > 0 && qty > 0) {
                        newRow.querySelector('.buy-total').value = formatNumber(Math.round(price * qty));
                    }
                }
                
                // 매도 정보 복원
                lastItem.querySelector('.sell1-date').value = stockInfo.sell1Date || '';
                lastItem.querySelector('.sell1-price').value = stockInfo.sell1Price || '';
                lastItem.querySelector('.sell2-date').value = stockInfo.sell2Date || '';
                lastItem.querySelector('.sell2-price').value = stockInfo.sell2Price || '';
                lastItem.querySelector('.sell3-date').value = stockInfo.sell3Date || '';
                lastItem.querySelector('.sell3-price').value = stockInfo.sell3Price || '';
                
                // 매도 D+일 자동 계산
                updateSellDplus(lastItem);
                
                // 매도 수량/금액 자동 계산
                calculateBuySellTotals(lastItem);
            });
        }
        
        // 초기화
        window.onload = function() {
            // 저장된 입력 데이터가 있으면 렌더링
            const inputData = JSON.parse(localStorage.getItem('chart_stats_input_data') || '[]');
            if (inputData.length > 0) {
                restoreFromInputData(inputData);
            } else {
                addStock();
            }
            
            // 구글 API 초기화
            gapiLoaded();
            gisLoaded();
            
            // 구글 API 초기화 대기 후 로그인 상태 복원
            const waitForInit = setInterval(async () => {
                if (gapiInited && gisInited) {
                    clearInterval(waitForInit);
                    await restoreLoginState();
                }
            }, 100);
        };
    </script>
</body>
</html>
