<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë§¤ë§¤ ê¸°ë¡ í†µê³„</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        h1 {
            color: white;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }
        
        h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.5em;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }
        
        .stock-item {
            background: #f5f5f5;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 5px solid #667eea;
        }
        
        .stock-result {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 15px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            margin-top: 10px;
        }
        
        .result-box {
            text-align: center;
        }
        
        .result-label {
            font-size: 0.85em;
            color: #666;
            margin-bottom: 5px;
        }
        
        .result-value {
            font-size: 1.2em;
            font-weight: bold;
        }
        
        .profit {
            color: #f44336;
        }
        
        .loss {
            color: #2196f3;
        }
        
        input[type="text"] {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: 600;
            font-size: 0.9em;
        }
        
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .btn-add {
            background: #4caf50;
            color: white;
            width: 100%;
            padding: 15px;
            font-size: 16px;
        }
        
        .btn-add:hover {
            background: #45a049;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(76,175,80,0.3);
        }
        
        .btn-delete {
            background: #f44336;
            color: white;
            padding: 8px 15px;
        }
        
        .btn-delete:hover {
            background: #da190b;
        }
        
        .btn-delete-row {
            background: #f44336;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .btn-delete-row:hover {
            background: #da190b;
        }
        
        .btn-add-buy {
            background: #4caf50;
            color: white;
            transition: all 0.3s;
        }
        
        .btn-add-buy:hover {
            background: #45a049;
            transform: translateY(-1px);
        }
        
        .btn-calculate {
            background: #667eea;
            color: white;
            padding: 10px 20px;
        }
        
        .btn-calculate:hover {
            background: #5568d3;
        }
        
        .action-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .btn-export {
            background: #2e7d32;
            color: white;
            padding: 15px;
            font-size: 16px;
        }
        
        .btn-export:hover {
            background: #1b5e20;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(46,125,50,0.3);
        }
        
        .btn-reset {
            background: #9e9e9e;
            color: white;
            padding: 15px;
            font-size: 16px;
        }
        
        .btn-reset:hover {
            background: #757575;
        }
        
        .statistics-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-top: 20px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        
        .stat-title {
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 10px;
        }
        
        .stat-value {
            font-size: 1.8em;
            font-weight: bold;
        }
        
        .total-stats {
            background: #fff3cd;
            padding: 20px;
            border-radius: 10px;
            border: 3px solid #ffc107;
        }
        
        .total-stats h3 {
            color: #856404;
            margin-bottom: 20px;
            text-align: center;
        }
        
        @media (max-width: 1024px) {
            .stock-result {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .statistics-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 768px) {
            .action-buttons {
                grid-template-columns: 1fr;
            }
            
            .statistics-grid {
                grid-template-columns: 1fr;
            }
            
            .stock-result {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .buy-row {
                grid-template-columns: 1fr 1fr !important;
            }
            
            .buy-row > div {
                grid-column: span 1;
            }
            
            .buy-row > div:nth-child(6),
            .buy-row > div:nth-child(7) {
                grid-column: span 2;
            }
        }
        
        .btn-google {
            background: #4285f4;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-google:hover {
            background: #357ae8;
            transform: translateY(-1px);
        }
        
        .btn-google:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        
        .btn-backup {
            background: #10b981;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-backup:hover:not(:disabled) {
            background: #059669;
            transform: translateY(-1px);
        }
        
        .btn-backup:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            opacity: 0.5;
        }
        
        .btn-load {
            background: #f59e0b;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-load:hover:not(:disabled) {
            background: #d97706;
            transform: translateY(-1px);
        }
        
        .btn-load:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            opacity: 0.5;
        }
        
        .sync-status {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.85em;
            font-weight: 500;
        }
        
        .sync-status.disconnected {
            background: #fee;
            color: #c33;
        }
        
        .sync-status.connected {
            background: #efe;
            color: #3c3;
        }
        
        .sync-status.syncing {
            background: #ffc;
            color: #cc6;
        }
        
        .sync-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
        }
    </style>
</head>
<body>
    <div class="container">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
            <h1 style="margin: 0;">ğŸ“Š ë§¤ë§¤ ê¸°ë¡ í†µê³„</h1>
            <div style="display: flex; align-items: center; gap: 15px;">
                <div id="syncStatusContainer" style="display: flex; flex-direction: column; align-items: flex-end; gap: 5px;">
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <div id="syncStatus" class="sync-status disconnected">
                            <span class="sync-dot"></span>
                            <span id="statusText">ì—°ê²° ì•ˆë¨</span>
                        </div>
                        <button id="backupBtn" class="btn-backup" onclick="manualBackup()" disabled>
                            <span>ğŸ’¾</span>
                            <span>ë°±ì—…</span>
                        </button>
                        <button id="loadBtn" class="btn-load" onclick="manualLoad()" disabled>
                            <span>ğŸ“¥</span>
                            <span>ë¡œë“œ</span>
                        </button>
                        <button id="googleBtn" class="btn-google" onclick="handleAuthClick()">
                            <span>ğŸ”</span>
                            <span id="googleBtnText">êµ¬ê¸€ ë¡œê·¸ì¸</span>
                        </button>
                    </div>
                    <div id="lastSyncTime" style="font-size: 0.85em; color: #6c757d;"></div>
                </div>
            </div>
        </div>
        
        <div class="card">
            <h2>ğŸ’¼ ì¢…ëª©ë³„ ë§¤ë§¤ ê¸°ë¡</h2>
            
            <div id="stockList"></div>
            
            <button class="btn-add" onclick="addStock()">+ ì¢…ëª© ì¶”ê°€</button>
            
            <div class="action-buttons" style="margin-top: 20px;">
                <button class="btn-calculate" onclick="calculateAll()" style="width: 100%; font-size: 16px; padding: 15px;">ğŸ“ˆ ì „ì²´ ê³„ì‚°</button>
                <button class="btn-export" onclick="exportToExcel()">ğŸ“¥ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
                <button class="btn-reset" onclick="resetAll()">ğŸ”„ ì´ˆê¸°í™”</button>
            </div>
        </div>
        
        <div class="card" id="statsCard" style="display: none;">
            <div class="total-stats">
                <h3>ğŸ¯ ì „ì²´ í†µê³„</h3>
                <div class="statistics-grid">
                    <div class="stat-card">
                        <div class="stat-title">ì´ ê±°ë˜ ì¢…ëª©</div>
                        <div class="stat-value" id="totalStocks">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-title">ì´ íˆ¬ìê¸ˆì•¡</div>
                        <div class="stat-value" id="totalInvest">0ì›</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-title">ì´ ìˆ˜ìµê¸ˆ</div>
                        <div class="stat-value" id="totalProfit">0ì›</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-title">í‰ê·  ìˆ˜ìµë¥ </div>
                        <div class="stat-value" id="avgReturn">0%</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-title">ìŠ¹ë¥ </div>
                        <div class="stat-value" id="winRate">0%</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-title">ìµœê³  ìˆ˜ìµ</div>
                        <div class="stat-value" id="maxProfit">0ì›</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-title">ìµœëŒ€ ì†ì‹¤</div>
                        <div class="stat-value" id="maxLoss">0ì›</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-title">ìµœì¢… ìì‚°</div>
                        <div class="stat-value" id="finalAsset">0ì›</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // ========== êµ¬ê¸€ ë“œë¼ì´ë¸Œ API ì„¤ì • ==========
        const CLIENT_ID = '574140412573-n0jau2i3uph1v5p3hi9v004m44bnopq8.apps.googleusercontent.com';
        const API_KEY = '';
        const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';
        const SCOPES = 'https://www.googleapis.com/auth/drive.file';
        const FILE_NAME = 'chart_stats_data.json';
        
        let tokenClient;
        let gapiInited = false;
        let gisInited = false;
        let isSignedIn = false;
        let driveFileId = null;
        let tokenRefreshTimer = null; // í† í° ìë™ ê°±ì‹  íƒ€ì´ë¨¸
        
        // ë°ì´í„° ì €ì¥ (localStorageì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸°)
        let stockData = JSON.parse(localStorage.getItem('chart_stats_data') || '[]');
        
        // ìˆ«ìì— ì‰¼í‘œ ì¶”ê°€
        function formatNumber(num) {
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        }
        
        // ì‰¼í‘œ ì œê±°í•˜ê³  ìˆ«ìë¡œ ë³€í™˜
        function parseNumber(str) {
            return parseFloat(str.replace(/,/g, '')) || 0;
        }
        
        // ë‚ ì§œ í¬ë§· ë³€í™˜ (251015 -> 25-10-15)
        function formatDate(dateStr) {
            if (dateStr.length !== 6) return '';
            return `${dateStr.substring(0, 2)}-${dateStr.substring(2, 4)}-${dateStr.substring(4, 6)}`;
        }
        
        // ë‚ ì§œë¥¼ Date ê°ì²´ë¡œ ë³€í™˜ (251015 -> Date)
        function parseDate(dateStr) {
            if (dateStr.length !== 6) return null;
            const year = 2000 + parseInt(dateStr.substring(0, 2));
            const month = parseInt(dateStr.substring(2, 4)) - 1; // 0-based
            const day = parseInt(dateStr.substring(4, 6));
            return new Date(year, month, day);
        }
        
        // ë‘ ë‚ ì§œ ê°„ ì°¨ì´ ê³„ì‚° (ì¼ ë‹¨ìœ„)
        function getDaysDiff(date1Str, date2Str) {
            const d1 = parseDate(date1Str);
            const d2 = parseDate(date2Str);
            if (!d1 || !d2) return '';
            const diffTime = d2 - d1;
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            return `D+${diffDays}`;
        }
        
        // ì…ë ¥ í•„ë“œì— ì‰¼í‘œ ìë™ ì¶”ê°€
        function formatInput(input) {
            const cursorPos = input.selectionStart;
            const oldValue = input.value;
            const oldLength = oldValue.length;
            
            const numValue = oldValue.replace(/,/g, '');
            if (numValue === '') {
                input.value = '';
                return;
            }
            
            const cleanValue = numValue.replace(/[^\d.]/g, '');
            if (cleanValue === '') {
                input.value = '';
                return;
            }
            
            const parts = cleanValue.split('.');
            parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            const formatted = parts.join('.');
            
            input.value = formatted;
            
            try {
                const newLength = formatted.length;
                const diff = newLength - oldLength;
                input.setSelectionRange(cursorPos + diff, cursorPos + diff);
            } catch (e) {}
        }
        
        function addStock() {
            const stockList = document.getElementById('stockList');
            const index = stockList.children.length;
            
            const stockDiv = document.createElement('div');
            stockDiv.className = 'stock-item';
            stockDiv.dataset.index = index;
            
            stockDiv.innerHTML = `
                <div style="display: grid; grid-template-columns: 200px 1fr; gap: 15px; margin-bottom: 15px;">
                    <div>
                        <label>í¬ì°©ì¼ (ì˜ˆ: 251015)</label>
                        <input type="text" class="detect-date" placeholder="251015" maxlength="6" style="width: 100%;">
                        <div style="font-size: 0.85em; color: #666; margin-top: 5px;">
                            í¬ë§·: <span class="detect-date-formatted">--</span>
                        </div>
                    </div>
                    <div>
                        <label>ì¢…ëª©ëª…</label>
                        <input type="text" class="stock-name" placeholder="ì˜ˆ: ì‚¼ì„±ì „ì">
                    </div>
                </div>
                
                <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <h4 style="color: #1976d2; margin-bottom: 10px;">ğŸ’° ë§¤ìˆ˜ ì •ë³´</h4>
                    <div class="buy-list">
                        <div class="buy-row" style="display: grid; grid-template-columns: 120px 80px auto 1fr 1fr 1fr auto; gap: 10px; margin-bottom: 10px; align-items: center;">
                            <div>
                                <label style="font-size: 0.85em;">ë‚ ì§œ (251015)</label>
                                <input type="text" class="buy-date" placeholder="251015" maxlength="6">
                            </div>
                            <div>
                                <label style="font-size: 0.85em;">D+ì¼</label>
                                <input type="text" class="buy-dplus" placeholder="D+0" readonly style="background: #f5f5f5;">
                            </div>
                            <div>
                                <label style="font-size: 0.85em;">ì°¨ìˆ˜</label>
                                <input type="text" class="buy-order" value="1ì°¨ ë§¤ìˆ˜" readonly style="background: #f5f5f5;">
                            </div>
                            <div>
                                <label style="font-size: 0.85em;">ë§¤ìˆ˜ê°€</label>
                                <input type="text" class="buy-price" placeholder="ê°€ê²©" inputmode="numeric">
                            </div>
                            <div>
                                <label style="font-size: 0.85em;">ìˆ˜ëŸ‰</label>
                                <input type="text" class="buy-quantity" placeholder="ìˆ˜ëŸ‰" inputmode="numeric">
                            </div>
                            <div>
                                <label style="font-size: 0.85em;">ê¸ˆì•¡</label>
                                <input type="text" class="buy-total" placeholder="ìë™ê³„ì‚°" readonly style="background: #f5f5f5;">
                            </div>
                            <div style="display: flex; align-items: flex-end;">
                                <button class="btn-delete-row" onclick="deleteBuyRow(this)" style="display:none; padding: 8px 12px; font-size: 0.9em;">ì‚­ì œ</button>
                            </div>
                        </div>
                    </div>
                    <button class="btn-add-buy" onclick="addBuyRow(this)" style="background: #4caf50; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; width: 100%;">+ ë§¤ìˆ˜ ì¶”ê°€</button>
                </div>
                
                <div style="background: #fff3e0; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <h4 style="color: #f57c00; margin-bottom: 10px;">ğŸ’¸ ë§¤ë„ ì •ë³´ (3ë¶„í•  ìë™: 30%, 35%, ì”ëŸ‰)</h4>
                    
                    <div style="display: grid; grid-template-columns: 120px 80px auto 1fr 1fr 1fr; gap: 10px; margin-bottom: 10px; align-items: center;">
                        <div>
                            <label style="font-size: 0.85em;">ë‚ ì§œ (251015)</label>
                            <input type="text" class="sell1-date" placeholder="251015" maxlength="6">
                        </div>
                        <div>
                            <label style="font-size: 0.85em;">D+ì¼</label>
                            <input type="text" class="sell1-dplus" placeholder="D+0" readonly style="background: #f5f5f5;">
                        </div>
                        <div>
                            <label style="font-size: 0.85em;">ì°¨ìˆ˜</label>
                            <input type="text" value="1ì°¨ ë§¤ë„ (30%)" readonly style="background: #f5f5f5;">
                        </div>
                        <div>
                            <label style="font-size: 0.85em;">ë§¤ë„ê°€</label>
                            <input type="text" class="sell1-price" placeholder="ë§¤ë„ê°€" inputmode="numeric">
                        </div>
                        <div>
                            <label style="font-size: 0.85em;">ìˆ˜ëŸ‰</label>
                            <input type="text" class="sell1-quantity" placeholder="ìë™ê³„ì‚°" readonly style="background: #f5f5f5;">
                        </div>
                        <div>
                            <label style="font-size: 0.85em;">ê¸ˆì•¡</label>
                            <input type="text" class="sell1-total" placeholder="ìë™ê³„ì‚°" readonly style="background: #f5f5f5;">
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 120px 80px auto 1fr 1fr 1fr; gap: 10px; margin-bottom: 10px; align-items: center;">
                        <div>
                            <label style="font-size: 0.85em;">ë‚ ì§œ (251015)</label>
                            <input type="text" class="sell2-date" placeholder="251015" maxlength="6">
                        </div>
                        <div>
                            <label style="font-size: 0.85em;">D+ì¼</label>
                            <input type="text" class="sell2-dplus" placeholder="D+0" readonly style="background: #f5f5f5;">
                        </div>
                        <div>
                            <label style="font-size: 0.85em;">ì°¨ìˆ˜</label>
                            <input type="text" value="2ì°¨ ë§¤ë„ (35%)" readonly style="background: #f5f5f5;">
                        </div>
                        <div>
                            <label style="font-size: 0.85em;">ë§¤ë„ê°€</label>
                            <input type="text" class="sell2-price" placeholder="ë§¤ë„ê°€" inputmode="numeric">
                        </div>
                        <div>
                            <label style="font-size: 0.85em;">ìˆ˜ëŸ‰</label>
                            <input type="text" class="sell2-quantity" placeholder="ìë™ê³„ì‚°" readonly style="background: #f5f5f5;">
                        </div>
                        <div>
                            <label style="font-size: 0.85em;">ê¸ˆì•¡</label>
                            <input type="text" class="sell2-total" placeholder="ìë™ê³„ì‚°" readonly style="background: #f5f5f5;">
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 120px 80px auto 1fr 1fr 1fr; gap: 10px; margin-bottom: 10px; align-items: center;">
                        <div>
                            <label style="font-size: 0.85em;">ë‚ ì§œ (251015)</label>
                            <input type="text" class="sell3-date" placeholder="251015" maxlength="6">
                        </div>
                        <div>
                            <label style="font-size: 0.85em;">D+ì¼</label>
                            <input type="text" class="sell3-dplus" placeholder="D+0" readonly style="background: #f5f5f5;">
                        </div>
                        <div>
                            <label style="font-size: 0.85em;">ì°¨ìˆ˜</label>
                            <input type="text" value="3ì°¨ ë§¤ë„ (ì”ëŸ‰)" readonly style="background: #f5f5f5;">
                        </div>
                        <div>
                            <label style="font-size: 0.85em;">ë§¤ë„ê°€</label>
                            <input type="text" class="sell3-price" placeholder="ë§¤ë„ê°€" inputmode="numeric">
                        </div>
                        <div>
                            <label style="font-size: 0.85em;">ìˆ˜ëŸ‰</label>
                            <input type="text" class="sell3-quantity" placeholder="ìë™ê³„ì‚°" readonly style="background: #f5f5f5;">
                        </div>
                        <div>
                            <label style="font-size: 0.85em;">ê¸ˆì•¡</label>
                            <input type="text" class="sell3-total" placeholder="ìë™ê³„ì‚°" readonly style="background: #f5f5f5;">
                        </div>
                    </div>
                </div>
                
                <div style="text-align: right;">
                    <button class="btn-delete" onclick="deleteStock(this)">ì‚­ì œ</button>
                </div>
                
                <div class="stock-result" style="display: none;">
                    <div class="result-box">
                        <div class="result-label">ì´ ë§¤ìˆ˜ê¸ˆì•¡</div>
                        <div class="result-value buy-amount">0ì›</div>
                    </div>
                    <div class="result-box">
                        <div class="result-label">ì´ ë§¤ë„ê¸ˆì•¡</div>
                        <div class="result-value sell-amount">0ì›</div>
                    </div>
                    <div class="result-box">
                        <div class="result-label">í‰ë‹¨ê°€</div>
                        <div class="result-value avg-price">0ì›</div>
                    </div>
                    <div class="result-box">
                        <div class="result-label">ì´ ìˆ˜ìµê¸ˆ</div>
                        <div class="result-value profit-amount">0ì›</div>
                    </div>
                    <div class="result-box">
                        <div class="result-label">í‰ê·  ìˆ˜ìµë¥ </div>
                        <div class="result-value profit-rate">0%</div>
                    </div>
                    <div class="result-box">
                        <div class="result-label">ë³´ìœ ìˆ˜ëŸ‰</div>
                        <div class="result-value remaining-qty">0ì£¼</div>
                    </div>
                </div>
            `;
            
            stockList.appendChild(stockDiv);
            
            // í¬ì°©ì¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
            const detectDateInput = stockDiv.querySelector('.detect-date');
            detectDateInput.addEventListener('input', function() {
                const formatted = formatDate(this.value);
                stockDiv.querySelector('.detect-date-formatted').textContent = formatted || '--';
                updateBuyDplus(stockDiv);
            });
            
            // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€ - ë§¤ìˆ˜
            const buyInputs = stockDiv.querySelectorAll('.buy-row input[inputmode="numeric"]');
            buyInputs.forEach(input => {
                input.addEventListener('input', function() {
                    formatInput(this);
                    calculateBuySellTotals(stockDiv);
                });
            });
            
            // ë§¤ìˆ˜ ë‚ ì§œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
            const buyDateInputs = stockDiv.querySelectorAll('.buy-date');
            buyDateInputs.forEach(input => {
                input.addEventListener('input', function() {
                    updateBuyDplus(stockDiv);
                    updateSellDplus(stockDiv);
                });
            });
            
            // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€ - ë§¤ë„ê°€
            const sellPriceInputs = stockDiv.querySelectorAll('.sell1-price, .sell2-price, .sell3-price');
            sellPriceInputs.forEach(input => {
                input.addEventListener('input', function() {
                    formatInput(this);
                    calculateBuySellTotals(stockDiv);
                });
            });
            
            // ë§¤ë„ ë‚ ì§œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
            const sellDateInputs = stockDiv.querySelectorAll('.sell1-date, .sell2-date, .sell3-date');
            sellDateInputs.forEach(input => {
                input.addEventListener('input', function() {
                    updateSellDplus(stockDiv);
                });
            });
        }
        
        // ë§¤ìˆ˜ D+ ì—…ë°ì´íŠ¸
        function updateBuyDplus(stockDiv) {
            const detectDate = stockDiv.querySelector('.detect-date').value;
            const buyRows = stockDiv.querySelectorAll('.buy-row');
            
            buyRows.forEach(row => {
                const buyDate = row.querySelector('.buy-date').value;
                const dplusInput = row.querySelector('.buy-dplus');
                if (detectDate && buyDate) {
                    dplusInput.value = getDaysDiff(detectDate, buyDate);
                } else {
                    dplusInput.value = '';
                }
            });
        }
        
        // ë§¤ë„ D+ ì—…ë°ì´íŠ¸
        function updateSellDplus(stockDiv) {
            // ì²« ë²ˆì§¸ ë§¤ìˆ˜ ë‚ ì§œë¥¼ ê¸°ì¤€ìœ¼ë¡œ
            const firstBuyDate = stockDiv.querySelector('.buy-date').value;
            
            for (let i = 1; i <= 3; i++) {
                const sellDate = stockDiv.querySelector(`.sell${i}-date`).value;
                const dplusInput = stockDiv.querySelector(`.sell${i}-dplus`);
                if (firstBuyDate && sellDate) {
                    dplusInput.value = getDaysDiff(firstBuyDate, sellDate);
                } else {
                    dplusInput.value = '';
                }
            }
        }
        
        // ë§¤ìˆ˜ í–‰ ì¶”ê°€
        function addBuyRow(button) {
            const stockDiv = button.closest('.stock-item');
            const buyList = stockDiv.querySelector('.buy-list');
            const currentRows = buyList.querySelectorAll('.buy-row').length;
            
            const newRow = document.createElement('div');
            newRow.className = 'buy-row';
            newRow.style.cssText = 'display: grid; grid-template-columns: 120px 80px auto 1fr 1fr 1fr auto; gap: 10px; margin-bottom: 10px; align-items: center;';
            newRow.innerHTML = `
                <div>
                    <label style="font-size: 0.85em;">ë‚ ì§œ (251015)</label>
                    <input type="text" class="buy-date" placeholder="251015" maxlength="6">
                </div>
                <div>
                    <label style="font-size: 0.85em;">D+ì¼</label>
                    <input type="text" class="buy-dplus" placeholder="D+0" readonly style="background: #f5f5f5;">
                </div>
                <div>
                    <label style="font-size: 0.85em;">ì°¨ìˆ˜</label>
                    <input type="text" class="buy-order" value="${currentRows + 1}ì°¨ ë§¤ìˆ˜" readonly style="background: #f5f5f5;">
                </div>
                <div>
                    <label style="font-size: 0.85em;">ë§¤ìˆ˜ê°€</label>
                    <input type="text" class="buy-price" placeholder="ê°€ê²©" inputmode="numeric">
                </div>
                <div>
                    <label style="font-size: 0.85em;">ìˆ˜ëŸ‰</label>
                    <input type="text" class="buy-quantity" placeholder="ìˆ˜ëŸ‰" inputmode="numeric">
                </div>
                <div>
                    <label style="font-size: 0.85em;">ê¸ˆì•¡</label>
                    <input type="text" class="buy-total" placeholder="ìë™ê³„ì‚°" readonly style="background: #f5f5f5;">
                </div>
                <div style="display: flex; align-items: flex-end;">
                    <button class="btn-delete-row" onclick="deleteBuyRow(this)" style="padding: 8px 12px; font-size: 0.9em;">ì‚­ì œ</button>
                </div>
            `;
            
            buyList.appendChild(newRow);
            
            // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€ - ìˆ«ì ì…ë ¥
            const inputs = newRow.querySelectorAll('input[inputmode="numeric"]');
            inputs.forEach(input => {
                input.addEventListener('input', function() {
                    formatInput(this);
                    calculateBuySellTotals(stockDiv);
                });
            });
            
            // ë‚ ì§œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
            const dateInput = newRow.querySelector('.buy-date');
            dateInput.addEventListener('input', function() {
                updateBuyDplus(stockDiv);
                updateSellDplus(stockDiv);
            });
            
            // ì²« ë²ˆì§¸ í–‰ì˜ ì‚­ì œ ë²„íŠ¼ í‘œì‹œ
            const firstDelete = buyList.querySelector('.btn-delete-row');
            if (firstDelete) {
                firstDelete.style.display = 'block';
            }
        }
        
        // ë§¤ìˆ˜ í–‰ ì‚­ì œ
        function deleteBuyRow(button) {
            const stockDiv = button.closest('.stock-item');
            const buyList = stockDiv.querySelector('.buy-list');
            button.closest('.buy-row').remove();
            
            // í–‰ì´ 1ê°œë§Œ ë‚¨ìœ¼ë©´ ì‚­ì œ ë²„íŠ¼ ìˆ¨ê¹€
            const rows = buyList.querySelectorAll('.buy-row');
            if (rows.length === 1) {
                const deleteBtn = rows[0].querySelector('.btn-delete-row');
                if (deleteBtn) deleteBtn.style.display = 'none';
            }
            
            // ì°¨ìˆ˜ ì¬ê³„ì‚°
            rows.forEach((row, index) => {
                row.querySelector('.buy-order').value = `${index + 1}ì°¨ ë§¤ìˆ˜`;
            });
            
            calculateBuySellTotals(stockDiv);
            updateSellDplus(stockDiv);
        }
        
        // ë§¤ìˆ˜/ë§¤ë„ ê¸ˆì•¡ ìë™ ê³„ì‚°
        function calculateBuySellTotals(stockDiv) {
            // ë§¤ìˆ˜ ê³„ì‚°
            const buyRows = stockDiv.querySelectorAll('.buy-row');
            let totalBuyQty = 0;
            
            buyRows.forEach(row => {
                const price = parseNumber(row.querySelector('.buy-price').value);
                const quantity = parseNumber(row.querySelector('.buy-quantity').value);
                const total = price * quantity;
                row.querySelector('.buy-total').value = total > 0 ? formatNumber(Math.round(total)) : '';
                totalBuyQty += quantity;
            });
            
            // ë§¤ë„ ê³„ì‚° (1ì°¨: 30%, 2ì°¨: 35%, 3ì°¨: ì”ëŸ‰ ì „ë¶€)
            const sell1Qty = Math.floor(totalBuyQty * 0.3);
            const sell2Qty = Math.floor(totalBuyQty * 0.35);
            const sell3Qty = totalBuyQty - sell1Qty - sell2Qty; // ì”ëŸ‰ ì „ë¶€
            
            const quantities = [sell1Qty, sell2Qty, sell3Qty];
            
            for (let i = 1; i <= 3; i++) {
                const priceInput = stockDiv.querySelector(`.sell${i}-price`);
                const qtyInput = stockDiv.querySelector(`.sell${i}-quantity`);
                const totalInput = stockDiv.querySelector(`.sell${i}-total`);
                
                const price = parseNumber(priceInput.value);
                const quantity = quantities[i-1];
                const total = price * quantity;
                
                qtyInput.value = quantity > 0 ? formatNumber(quantity) : '';
                totalInput.value = total > 0 ? formatNumber(Math.round(total)) : '';
            }
        }
        
        function deleteStock(button) {
            button.closest('.stock-item').remove();
            saveToLocalStorage();
            saveToGoogleDrive();
        }
        
        function calculateAll() {
            const stockItems = document.querySelectorAll('.stock-item');
            stockData = [];
            
            let totalInvest = 0;
            let totalProfit = 0;
            let winCount = 0;
            let maxProfit = 0;
            let maxLoss = 0;
            
            stockItems.forEach((item, index) => {
                const name = item.querySelector('.stock-name').value || `ì¢…ëª©${index + 1}`;
                const detectDate = item.querySelector('.detect-date').value;
                const detectDateFormatted = formatDate(detectDate);
                
                // ë§¤ìˆ˜ ì •ë³´ ìˆ˜ì§‘
                let totalBuyAmount = 0;
                let totalBuyQty = 0;
                const buyData = [];
                
                const buyRows = item.querySelectorAll('.buy-row');
                buyRows.forEach((row, idx) => {
                    const date = row.querySelector('.buy-date').value;
                    const dateFormatted = formatDate(date);
                    const dplus = row.querySelector('.buy-dplus').value;
                    const price = parseNumber(row.querySelector('.buy-price').value);
                    const qty = parseNumber(row.querySelector('.buy-quantity').value);
                    if (price > 0 && qty > 0) {
                        totalBuyAmount += price * qty;
                        totalBuyQty += qty;
                        buyData.push({ 
                            order: `${idx + 1}ì°¨`,
                            date: dateFormatted,
                            dplus: dplus,
                            price, 
                            qty, 
                            amount: price * qty 
                        });
                    }
                });
                
                // ë§¤ë„ ì •ë³´ ìˆ˜ì§‘ (1ì°¨: 30%, 2ì°¨: 35%, 3ì°¨: ì”ëŸ‰ ì „ë¶€)
                let totalSellAmount = 0;
                let totalSellQty = 0;
                const sellData = [];
                
                const sell1Qty = Math.floor(totalBuyQty * 0.3);
                const sell2Qty = Math.floor(totalBuyQty * 0.35);
                const sell3Qty = totalBuyQty - sell1Qty - sell2Qty; // ì”ëŸ‰ ì „ë¶€
                const quantities = [sell1Qty, sell2Qty, sell3Qty];
                const ratios = [0.3, 0.35, null]; // 3ì°¨ëŠ” ì”ëŸ‰
                
                for (let i = 1; i <= 3; i++) {
                    const date = item.querySelector(`.sell${i}-date`).value;
                    const dateFormatted = formatDate(date);
                    const dplus = item.querySelector(`.sell${i}-dplus`).value;
                    const price = parseNumber(item.querySelector(`.sell${i}-price`).value);
                    const qty = quantities[i-1];
                    
                    if (price > 0 && qty > 0) {
                        totalSellAmount += price * qty;
                        totalSellQty += qty;
                        sellData.push({ 
                            order: `${i}ì°¨`,
                            date: dateFormatted,
                            dplus: dplus,
                            price, 
                            qty, 
                            amount: price * qty, 
                            ratio: ratios[i-1],
                            description: i === 3 ? 'ì”ëŸ‰' : `${(ratios[i-1] * 100).toFixed(0)}%`
                        });
                    }
                }
                
                if (totalBuyQty > 0) {
                    const avgPrice = totalBuyAmount / totalBuyQty;
                    const profit = totalSellAmount - (avgPrice * totalSellQty);
                    const profitRate = totalSellQty > 0 ? (profit / (avgPrice * totalSellQty) * 100) : 0;
                    const remainingQty = totalBuyQty - totalSellQty;
                    
                    totalInvest += totalBuyAmount;
                    totalProfit += profit;
                    
                    if (profit > 0) {
                        winCount++;
                    }
                    
                    if (profit > maxProfit) {
                        maxProfit = profit;
                    }
                    
                    if (profit < maxLoss) {
                        maxLoss = profit;
                    }
                    
                    // ê²°ê³¼ í‘œì‹œ
                    const resultDiv = item.querySelector('.stock-result');
                    resultDiv.style.display = 'grid';
                    
                    resultDiv.querySelector('.buy-amount').textContent = Math.round(totalBuyAmount).toLocaleString('ko-KR') + 'ì›';
                    resultDiv.querySelector('.sell-amount').textContent = Math.round(totalSellAmount).toLocaleString('ko-KR') + 'ì›';
                    resultDiv.querySelector('.avg-price').textContent = Math.round(avgPrice).toLocaleString('ko-KR') + 'ì›';
                    resultDiv.querySelector('.profit-amount').textContent = Math.round(profit).toLocaleString('ko-KR') + 'ì›';
                    resultDiv.querySelector('.profit-rate').textContent = profitRate.toFixed(2) + '%';
                    resultDiv.querySelector('.remaining-qty').textContent = remainingQty.toLocaleString('ko-KR') + 'ì£¼';
                    
                    // ìˆ˜ìµ/ì†ì‹¤ ìƒ‰ìƒ
                    const profitElement = resultDiv.querySelector('.profit-amount');
                    const rateElement = resultDiv.querySelector('.profit-rate');
                    if (profit >= 0) {
                        profitElement.className = 'result-value profit';
                        rateElement.className = 'result-value profit';
                    } else {
                        profitElement.className = 'result-value loss';
                        rateElement.className = 'result-value loss';
                    }
                    
                    // ë°ì´í„° ì €ì¥ (ì—‘ì…€ìš©)
                    const stockRecord = {
                        ì¢…ëª©ëª…: name,
                        í¬ì°©ì¼: detectDateFormatted,
                        í‰ë‹¨ê°€: avgPrice,
                        ì´ë§¤ìˆ˜ìˆ˜ëŸ‰: totalBuyQty,
                        ì´ë§¤ìˆ˜ê¸ˆì•¡: totalBuyAmount,
                        ì´ë§¤ë„ìˆ˜ëŸ‰: totalSellQty,
                        ì´ë§¤ë„ê¸ˆì•¡: totalSellAmount,
                        ìˆ˜ìµê¸ˆ: profit,
                        ìˆ˜ìµë¥ : profitRate,
                        ë³´ìœ ìˆ˜ëŸ‰: remainingQty,
                        ë§¤ìˆ˜ë‚´ì—­: buyData,
                        ë§¤ë„ë‚´ì—­: sellData
                    };
                    
                    stockData.push(stockRecord);
                }
            });
            
            // ì „ì²´ í†µê³„ í‘œì‹œ
            if (stockData.length > 0) {
                const avgReturn = (totalProfit / totalInvest * 100);
                const winRate = (winCount / stockData.length * 100);
                const finalAsset = totalInvest + totalProfit;
                
                document.getElementById('totalStocks').textContent = stockData.length;
                document.getElementById('totalInvest').textContent = Math.round(totalInvest).toLocaleString('ko-KR') + 'ì›';
                document.getElementById('totalProfit').textContent = Math.round(totalProfit).toLocaleString('ko-KR') + 'ì›';
                document.getElementById('avgReturn').textContent = avgReturn.toFixed(2) + '%';
                document.getElementById('winRate').textContent = winRate.toFixed(1) + '%';
                document.getElementById('maxProfit').textContent = Math.round(maxProfit).toLocaleString('ko-KR') + 'ì›';
                document.getElementById('maxLoss').textContent = Math.round(maxLoss).toLocaleString('ko-KR') + 'ì›';
                document.getElementById('finalAsset').textContent = Math.round(finalAsset).toLocaleString('ko-KR') + 'ì›';
                
                // ìˆ˜ìµ/ì†ì‹¤ ìƒ‰ìƒ
                const profitEl = document.getElementById('totalProfit');
                const returnEl = document.getElementById('avgReturn');
                if (totalProfit >= 0) {
                    profitEl.style.color = '#f44336';
                    returnEl.style.color = '#f44336';
                } else {
                    profitEl.style.color = '#2196f3';
                    returnEl.style.color = '#2196f3';
                }
                
                document.getElementById('statsCard').style.display = 'block';
            } else {
                alert('ì…ë ¥ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤!');
            }
            
            // ë°ì´í„° ì €ì¥
            saveToLocalStorage();
            saveToGoogleDrive();
        }
        
        function exportToExcel() {
            if (stockData.length === 0) {
                alert('ë¨¼ì € ê³„ì‚°ì„ í•´ì£¼ì„¸ìš”!');
                return;
            }
            
            // ì—‘ì…€ ë°ì´í„° ì¤€ë¹„ - ê° ì¢…ëª©ë³„ë¡œ ì‹œíŠ¸ ìƒì„±
            const wb = XLSX.utils.book_new();
            
            // ì¢…ëª©ë³„ ìƒì„¸ ì‹œíŠ¸
            stockData.forEach((stock, idx) => {
                const ws_data = [
                    ['ì¢…ëª©ëª…', stock.ì¢…ëª©ëª…],
                    ['í¬ì°©ì¼', stock.í¬ì°©ì¼],
                    [],
                    ['=== ë§¤ìˆ˜ ë‚´ì—­ ==='],
                    ['ì°¨ìˆ˜', 'ë‚ ì§œ', 'D+ì¼', 'ë§¤ìˆ˜ê°€', 'ìˆ˜ëŸ‰', 'ê¸ˆì•¡']
                ];
                
                stock.ë§¤ìˆ˜ë‚´ì—­.forEach((buy) => {
                    ws_data.push([buy.order, buy.date, buy.dplus, buy.price, buy.qty, buy.amount]);
                });
                
                ws_data.push([]);
                ws_data.push(['ì´ ë§¤ìˆ˜ìˆ˜ëŸ‰', stock.ì´ë§¤ìˆ˜ìˆ˜ëŸ‰]);
                ws_data.push(['ì´ ë§¤ìˆ˜ê¸ˆì•¡', Math.round(stock.ì´ë§¤ìˆ˜ê¸ˆì•¡)]);
                ws_data.push(['í‰ë‹¨ê°€', Math.round(stock.í‰ë‹¨ê°€)]);
                
                ws_data.push([]);
                ws_data.push(['=== ë§¤ë„ ë‚´ì—­ ===']);
                ws_data.push(['ì°¨ìˆ˜', 'ë‚ ì§œ', 'D+ì¼', 'ë§¤ë„ê°€', 'ìˆ˜ëŸ‰', 'ê¸ˆì•¡', 'ë¹„ìœ¨']);
                
                stock.ë§¤ë„ë‚´ì—­.forEach((sell) => {
                    ws_data.push([sell.order, sell.date, sell.dplus, sell.price, sell.qty, sell.amount, sell.description]);
                });
                
                ws_data.push([]);
                ws_data.push(['ì´ ë§¤ë„ìˆ˜ëŸ‰', stock.ì´ë§¤ë„ìˆ˜ëŸ‰]);
                ws_data.push(['ì´ ë§¤ë„ê¸ˆì•¡', Math.round(stock.ì´ë§¤ë„ê¸ˆì•¡)]);
                
                ws_data.push([]);
                ws_data.push(['=== ìˆ˜ìµ ê²°ê³¼ ===']);
                ws_data.push(['ìˆ˜ìµê¸ˆ', Math.round(stock.ìˆ˜ìµê¸ˆ)]);
                ws_data.push(['ìˆ˜ìµë¥ (%)', stock.ìˆ˜ìµë¥ .toFixed(2)]);
                ws_data.push(['ë³´ìœ ìˆ˜ëŸ‰', stock.ë³´ìœ ìˆ˜ëŸ‰]);
                
                const ws = XLSX.utils.aoa_to_sheet(ws_data);
                ws['!cols'] = [{wch: 12}, {wch: 12}, {wch: 10}, {wch: 12}, {wch: 12}, {wch: 15}, {wch: 10}];
                
                XLSX.utils.book_append_sheet(wb, ws, `${stock.ì¢…ëª©ëª….substring(0, 10)}_${idx+1}`);
            });
            
            // ì „ì²´ ìš”ì•½ ì‹œíŠ¸
            const summary_data = [
                ['ì¢…ëª©ëª…', 'í¬ì°©ì¼', 'í‰ë‹¨ê°€', 'ì´ë§¤ìˆ˜ìˆ˜ëŸ‰', 'ì´ë§¤ìˆ˜ê¸ˆì•¡', 'ì´ë§¤ë„ìˆ˜ëŸ‰', 'ì´ë§¤ë„ê¸ˆì•¡', 'ìˆ˜ìµê¸ˆ', 'ìˆ˜ìµë¥ (%)', 'ë³´ìœ ìˆ˜ëŸ‰']
            ];
            
            stockData.forEach(stock => {
                summary_data.push([
                    stock.ì¢…ëª©ëª…,
                    stock.í¬ì°©ì¼,
                    Math.round(stock.í‰ë‹¨ê°€),
                    stock.ì´ë§¤ìˆ˜ìˆ˜ëŸ‰,
                    Math.round(stock.ì´ë§¤ìˆ˜ê¸ˆì•¡),
                    stock.ì´ë§¤ë„ìˆ˜ëŸ‰,
                    Math.round(stock.ì´ë§¤ë„ê¸ˆì•¡),
                    Math.round(stock.ìˆ˜ìµê¸ˆ),
                    stock.ìˆ˜ìµë¥ .toFixed(2),
                    stock.ë³´ìœ ìˆ˜ëŸ‰
                ]);
            });
            
            // í†µê³„ ì¶”ê°€
            summary_data.push([]);
            summary_data.push(['=== ì „ì²´ í†µê³„ ===']);
            summary_data.push(['ì´ ê±°ë˜ ì¢…ëª©', stockData.length]);
            
            let totalInvest = 0;
            let totalProfit = 0;
            let winCount = 0;
            let maxProfit = 0;
            let maxLoss = 0;
            
            stockData.forEach(stock => {
                totalInvest += stock.ì´ë§¤ìˆ˜ê¸ˆì•¡;
                totalProfit += stock.ìˆ˜ìµê¸ˆ;
                if (stock.ìˆ˜ìµê¸ˆ > 0) winCount++;
                if (stock.ìˆ˜ìµê¸ˆ > maxProfit) maxProfit = stock.ìˆ˜ìµê¸ˆ;
                if (stock.ìˆ˜ìµê¸ˆ < maxLoss) maxLoss = stock.ìˆ˜ìµê¸ˆ;
            });
            
            summary_data.push(['ì´ íˆ¬ìê¸ˆì•¡', Math.round(totalInvest)]);
            summary_data.push(['ì´ ìˆ˜ìµê¸ˆ', Math.round(totalProfit)]);
            summary_data.push(['í‰ê·  ìˆ˜ìµë¥ (%)', (totalProfit / totalInvest * 100).toFixed(2)]);
            summary_data.push(['ìŠ¹ë¥ (%)', (winCount / stockData.length * 100).toFixed(1)]);
            summary_data.push(['ìµœê³  ìˆ˜ìµ', Math.round(maxProfit)]);
            summary_data.push(['ìµœëŒ€ ì†ì‹¤', Math.round(maxLoss)]);
            summary_data.push(['ìµœì¢… ìì‚°', Math.round(totalInvest + totalProfit)]);
            
            const ws_summary = XLSX.utils.aoa_to_sheet(summary_data);
            ws_summary['!cols'] = [
                {wch: 15}, {wch: 12}, {wch: 12}, {wch: 12}, {wch: 15},
                {wch: 12}, {wch: 15}, {wch: 15}, {wch: 12}, {wch: 12}
            ];
            
            XLSX.utils.book_append_sheet(wb, ws_summary, 'ì „ì²´ìš”ì•½', true);
            // ì „ì²´ìš”ì•½ ì‹œíŠ¸ë¥¼ ë§¨ ì•ìœ¼ë¡œ ì´ë™
            wb.SheetNames.unshift(wb.SheetNames.pop());
            
            // íŒŒì¼ ë‹¤ìš´ë¡œë“œ
            const today = new Date();
            const dateStr = today.getFullYear() + 
                           String(today.getMonth() + 1).padStart(2, '0') + 
                           String(today.getDate()).padStart(2, '0');
            const filename = `ë§¤ë§¤ê¸°ë¡_${dateStr}.xlsx`;
            
            XLSX.writeFile(wb, filename);
        }
        
        function resetAll() {
            if (confirm('ëª¨ë“  ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                document.getElementById('stockList').innerHTML = '';
                document.getElementById('statsCard').style.display = 'none';
                stockData = [];
                saveToLocalStorage();
                saveToGoogleDrive();
            }
        }
        
        // ========== ë¡œì»¬ìŠ¤í† ë¦¬ì§€ ì €ì¥ ==========
        function saveToLocalStorage() {
            // DOMì˜ ëª¨ë“  ì…ë ¥ê°’ì„ ìˆ˜ì§‘
            const stockItems = document.querySelectorAll('.stock-item');
            const inputData = [];
            
            stockItems.forEach(item => {
                const stockInfo = {
                    detectDate: item.querySelector('.detect-date').value,
                    stockName: item.querySelector('.stock-name').value,
                    buyRows: [],
                    sell1Date: item.querySelector('.sell1-date').value,
                    sell1Price: item.querySelector('.sell1-price').value,
                    sell2Date: item.querySelector('.sell2-date').value,
                    sell2Price: item.querySelector('.sell2-price').value,
                    sell3Date: item.querySelector('.sell3-date').value,
                    sell3Price: item.querySelector('.sell3-price').value
                };
                
                // ë§¤ìˆ˜ ì •ë³´ ìˆ˜ì§‘
                const buyRows = item.querySelectorAll('.buy-row');
                buyRows.forEach(row => {
                    stockInfo.buyRows.push({
                        date: row.querySelector('.buy-date').value,
                        price: row.querySelector('.buy-price').value,
                        quantity: row.querySelector('.buy-quantity').value
                    });
                });
                
                inputData.push(stockInfo);
            });
            
            localStorage.setItem('chart_stats_input_data', JSON.stringify(inputData));
            localStorage.setItem('chart_stats_data', JSON.stringify(stockData));
        }
        
        // ========== êµ¬ê¸€ API ì´ˆê¸°í™” ==========
        function gapiLoaded() {
            gapi.load('client', initializeGapiClient);
        }

        async function initializeGapiClient() {
            await gapi.client.init({
                apiKey: API_KEY,
                discoveryDocs: [DISCOVERY_DOC],
            });
            gapiInited = true;
            maybeEnableButtons();
        }

        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: '',
            });
            gisInited = true;
            maybeEnableButtons();
        }

        function maybeEnableButtons() {
            if (gapiInited && gisInited) {
                document.getElementById('googleBtn').disabled = false;
            }
        }

        function handleAuthClick() {
            if (isSignedIn) {
                handleSignoutClick();
            } else {
                tokenClient.callback = async (resp) => {
                    if (resp.error !== undefined) {
                        throw (resp);
                    }
                    
                    // í† í°ì„ localStorageì— ì €ì¥
                    localStorage.setItem('google_access_token_chartstats', resp.access_token);
                    if (resp.expires_in) {
                        const expiryTime = Date.now() + (resp.expires_in * 1000);
                        localStorage.setItem('google_token_expiry_chartstats', expiryTime.toString());
                        
                        // í† í° ìë™ ê°±ì‹  íƒ€ì´ë¨¸ ì„¤ì • (ë§Œë£Œ 5ë¶„ ì „ì— ê°±ì‹ )
                        setupTokenRefresh(resp.expires_in);
                    }
                    
                    isSignedIn = true;
                    updateSyncStatus('connected', 'ì—°ê²°ë¨');
                    document.getElementById('googleBtnText').textContent = 'ë¡œê·¸ì•„ì›ƒ';
                    document.getElementById('backupBtn').disabled = false;
                    document.getElementById('loadBtn').disabled = false;
                    await loadFromGoogleDrive();
                };

                if (gapi.client.getToken() === null) {
                    tokenClient.requestAccessToken({prompt: 'consent'});
                } else {
                    tokenClient.requestAccessToken({prompt: ''});
                }
            }
        }

        function handleSignoutClick() {
            const token = gapi.client.getToken();
            if (token !== null) {
                google.accounts.oauth2.revoke(token.access_token);
                gapi.client.setToken('');
            }
            
            // í† í° ê°±ì‹  íƒ€ì´ë¨¸ ì •ë¦¬
            if (tokenRefreshTimer) {
                clearTimeout(tokenRefreshTimer);
                tokenRefreshTimer = null;
            }
            
            // localStorageì—ì„œ í† í° ì‚­ì œ
            localStorage.removeItem('google_access_token_chartstats');
            localStorage.removeItem('google_token_expiry_chartstats');
            
            isSignedIn = false;
            updateSyncStatus('disconnected', 'ì—°ê²° ì•ˆë¨');
            document.getElementById('googleBtnText').textContent = 'êµ¬ê¸€ ë¡œê·¸ì¸';
            document.getElementById('lastSyncTime').textContent = '';
            document.getElementById('backupBtn').disabled = true;
            document.getElementById('loadBtn').disabled = true;
        }

        // ========== ì €ì¥ëœ í† í°ìœ¼ë¡œ ë¡œê·¸ì¸ ë³µì› ==========
        async function restoreLoginState() {
            const savedToken = localStorage.getItem('google_access_token_chartstats');
            const tokenExpiry = localStorage.getItem('google_token_expiry_chartstats');
            
            if (savedToken && tokenExpiry) {
                if (Date.now() < parseInt(tokenExpiry)) {
                    gapi.client.setToken({
                        access_token: savedToken
                    });
                    
                    isSignedIn = true;
                    updateSyncStatus('connected', 'ì—°ê²°ë¨');
                    document.getElementById('googleBtnText').textContent = 'ë¡œê·¸ì•„ì›ƒ';
                    document.getElementById('backupBtn').disabled = false;
                    document.getElementById('loadBtn').disabled = false;
                    
                    // ë‚¨ì€ ì‹œê°„ ê³„ì‚°í•˜ì—¬ í† í° ìë™ ê°±ì‹  íƒ€ì´ë¨¸ ì„¤ì •
                    const remainingSeconds = Math.floor((parseInt(tokenExpiry) - Date.now()) / 1000);
                    setupTokenRefresh(remainingSeconds);
                    
                    await loadFromGoogleDrive();
                } else {
                    localStorage.removeItem('google_access_token_chartstats');
                    localStorage.removeItem('google_token_expiry_chartstats');
                }
            }
        }

        // ========== í† í° ìë™ ê°±ì‹  ì„¤ì • ==========
        function setupTokenRefresh(expiresInSeconds) {
            // ê¸°ì¡´ íƒ€ì´ë¨¸ê°€ ìˆìœ¼ë©´ ì œê±°
            if (tokenRefreshTimer) {
                clearTimeout(tokenRefreshTimer);
            }
            
            // ë§Œë£Œ 5ë¶„ ì „ì— ê°±ì‹  (ìµœì†Œ 1ë¶„ ì „)
            const refreshTime = Math.max((expiresInSeconds - 300) * 1000, 60 * 1000);
            
            tokenRefreshTimer = setTimeout(async () => {
                if (isSignedIn && tokenClient) {
                    try {
                        // íŒì—… ì—†ì´ ìë™ ê°±ì‹  ì‹œë„
                        tokenClient.callback = async (resp) => {
                            if (resp.error === undefined) {
                                // í† í°ì„ localStorageì— ì €ì¥
                                localStorage.setItem('google_access_token_chartstats', resp.access_token);
                                if (resp.expires_in) {
                                    const expiryTime = Date.now() + (resp.expires_in * 1000);
                                    localStorage.setItem('google_token_expiry_chartstats', expiryTime.toString());
                                    
                                    // ë‹¤ì‹œ íƒ€ì´ë¨¸ ì„¤ì •
                                    setupTokenRefresh(resp.expires_in);
                                }
                                
                                gapi.client.setToken({
                                    access_token: resp.access_token
                                });
                                
                                console.log('í† í°ì´ ìë™ìœ¼ë¡œ ê°±ì‹ ë˜ì—ˆìŠµë‹ˆë‹¤.');
                            }
                        };
                        
                        tokenClient.requestAccessToken({prompt: ''});
                    } catch (err) {
                        console.error('í† í° ìë™ ê°±ì‹  ì‹¤íŒ¨:', err);
                    }
                }
            }, refreshTime);
        }

        function updateSyncStatus(status, text) {
            const statusEl = document.getElementById('syncStatus');
            const textEl = document.getElementById('statusText');
            if (statusEl && textEl) {
                statusEl.className = `sync-status ${status}`;
                textEl.textContent = text;
            }
        }

        function updateLastSyncTime() {
            const now = new Date();
            const timeStr = now.toLocaleString('ko-KR', { 
                month: '2-digit', 
                day: '2-digit', 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            document.getElementById('lastSyncTime').textContent = `ë§ˆì§€ë§‰ ë™ê¸°í™”: ${timeStr}`;
        }

        // ========== êµ¬ê¸€ ë“œë¼ì´ë¸Œ íŒŒì¼ ì°¾ê¸° ==========
        async function findDriveFile() {
            try {
                const response = await gapi.client.drive.files.list({
                    q: `name='${FILE_NAME}' and trashed=false`,
                    spaces: 'drive',
                    fields: 'files(id, name)',
                });
                const files = response.result.files;
                if (files && files.length > 0) {
                    return files[0].id;
                }
                return null;
            } catch (err) {
                console.error('íŒŒì¼ ê²€ìƒ‰ ì˜¤ë¥˜:', err);
                return null;
            }
        }

        // ========== êµ¬ê¸€ ë“œë¼ì´ë¸Œì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸° ==========
        async function loadFromGoogleDrive() {
            if (!isSignedIn) return;
            
            updateSyncStatus('syncing', 'ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...');
            
            try {
                driveFileId = await findDriveFile();
                
                if (driveFileId) {
                    const response = await gapi.client.drive.files.get({
                        fileId: driveFileId,
                        alt: 'media',
                    });
                    
                    const data = JSON.parse(response.body);
                    localStorage.setItem('chart_stats_input_data', JSON.stringify(data));
                    
                    // UI ì—…ë°ì´íŠ¸
                    restoreFromInputData(data);
                    
                    updateSyncStatus('connected', 'ì—°ê²°ë¨');
                    updateLastSyncTime();
                } else {
                    updateSyncStatus('connected', 'ì—°ê²°ë¨ (íŒŒì¼ ì—†ìŒ)');
                }
            } catch (err) {
                console.error('ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜:', err);
                updateSyncStatus('connected', 'ì—°ê²°ë¨');
            }
        }

        // ========== êµ¬ê¸€ ë“œë¼ì´ë¸Œì— ì €ì¥ ==========
        async function saveToGoogleDrive() {
            if (!isSignedIn) return;
            
            updateSyncStatus('syncing', 'ì €ì¥ ì¤‘...');
            
            try {
                // ì…ë ¥ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                const inputData = JSON.parse(localStorage.getItem('chart_stats_input_data') || '[]');
                const data = JSON.stringify(inputData, null, 2);
                const blob = new Blob([data], { type: 'application/json' });
                
                if (driveFileId) {
                    const metadata = {
                        name: FILE_NAME,
                        mimeType: 'application/json',
                    };
                    
                    const form = new FormData();
                    form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                    form.append('file', blob);
                    
                    await fetch(`https://www.googleapis.com/upload/drive/v3/files/${driveFileId}?uploadType=multipart`, {
                        method: 'PATCH',
                        headers: new Headers({ 'Authorization': 'Bearer ' + gapi.client.getToken().access_token }),
                        body: form,
                    });
                } else {
                    const metadata = {
                        name: FILE_NAME,
                        mimeType: 'application/json',
                    };
                    
                    const form = new FormData();
                    form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                    form.append('file', blob);
                    
                    const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                        method: 'POST',
                        headers: new Headers({ 'Authorization': 'Bearer ' + gapi.client.getToken().access_token }),
                        body: form,
                    });
                    
                    const result = await response.json();
                    driveFileId = result.id;
                }
                
                updateSyncStatus('connected', 'ì—°ê²°ë¨');
                updateLastSyncTime();
            } catch (err) {
                console.error('ì €ì¥ ì˜¤ë¥˜:', err);
                updateSyncStatus('connected', 'ì—°ê²°ë¨ (ì €ì¥ ì‹¤íŒ¨)');
            }
        }

        // ========== ìˆ˜ë™ ë°±ì—… ==========
        async function manualBackup() {
            if (!isSignedIn) {
                alert('êµ¬ê¸€ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                return;
            }
            
            if (confirm('í˜„ì¬ ë°ì´í„°ë¥¼ êµ¬ê¸€ ë“œë¼ì´ë¸Œì— ë°±ì—…í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                await saveToGoogleDrive();
                alert('ë°±ì—…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
            }
        }

        // ========== ìˆ˜ë™ ë¶ˆëŸ¬ì˜¤ê¸° ==========
        async function manualLoad() {
            if (!isSignedIn) {
                alert('êµ¬ê¸€ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                return;
            }
            
            if (confirm('êµ¬ê¸€ ë“œë¼ì´ë¸Œì—ì„œ ë°ì´í„°ë¥¼ ë¡œë“œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\ní˜„ì¬ ë°ì´í„°ëŠ” ë®ì–´ì”Œì›Œì§‘ë‹ˆë‹¤.')) {
                await loadFromGoogleDrive();
                alert('ë°ì´í„°ë¥¼ ë¡œë“œí–ˆìŠµë‹ˆë‹¤!');
            }
        }

        // ========== ëª¨ë“  ì¢…ëª© ë Œë”ë§ ==========
        function renderAllStocks() {
            const inputData = JSON.parse(localStorage.getItem('chart_stats_input_data') || '[]');
            if (inputData.length > 0) {
                restoreFromInputData(inputData);
            }
        }
        
        // ========== ì…ë ¥ ë°ì´í„°ì—ì„œ DOM ë³µì› ==========
        function restoreFromInputData(inputData) {
            const container = document.getElementById('stockList');
            container.innerHTML = '';
            
            if (inputData.length === 0) {
                addStock();
                return;
            }
            
            inputData.forEach(stockInfo => {
                addStock();
                const stockItems = document.querySelectorAll('.stock-item');
                const lastItem = stockItems[stockItems.length - 1];
                
                // ê¸°ë³¸ ì •ë³´ ë³µì›
                lastItem.querySelector('.detect-date').value = stockInfo.detectDate || '';
                lastItem.querySelector('.stock-name').value = stockInfo.stockName || '';
                
                // í¬ì°©ì¼ í¬ë§· í‘œì‹œ
                const formatted = formatDate(stockInfo.detectDate);
                lastItem.querySelector('.detect-date-formatted').textContent = formatted || '--';
                
                // ë§¤ìˆ˜ ì •ë³´ ë³µì›
                const buyList = lastItem.querySelector('.buy-list');
                const existingBuyRows = buyList.querySelectorAll('.buy-row');
                
                // ì²« ë²ˆì§¸ í–‰ ì—…ë°ì´íŠ¸
                if (stockInfo.buyRows.length > 0 && existingBuyRows.length > 0) {
                    const firstRow = existingBuyRows[0];
                    firstRow.querySelector('.buy-date').value = stockInfo.buyRows[0].date || '';
                    firstRow.querySelector('.buy-price').value = stockInfo.buyRows[0].price || '';
                    firstRow.querySelector('.buy-quantity').value = stockInfo.buyRows[0].quantity || '';
                    
                    // D+ì¼ ìë™ ê³„ì‚°
                    updateBuyDplus(lastItem);
                    
                    // ê¸ˆì•¡ ìë™ ê³„ì‚°
                    const price = parseNumber(stockInfo.buyRows[0].price);
                    const qty = parseNumber(stockInfo.buyRows[0].quantity);
                    if (price > 0 && qty > 0) {
                        firstRow.querySelector('.buy-total').value = formatNumber(Math.round(price * qty));
                    }
                }
                
                // ì¶”ê°€ ë§¤ìˆ˜ í–‰ë“¤
                for (let i = 1; i < stockInfo.buyRows.length; i++) {
                    const addBtn = lastItem.querySelector('.btn-add-buy');
                    addBuyRow(addBtn);
                    
                    const rows = lastItem.querySelectorAll('.buy-row');
                    const newRow = rows[i];
                    newRow.querySelector('.buy-date').value = stockInfo.buyRows[i].date || '';
                    newRow.querySelector('.buy-price').value = stockInfo.buyRows[i].price || '';
                    newRow.querySelector('.buy-quantity').value = stockInfo.buyRows[i].quantity || '';
                    
                    // D+ì¼ ìë™ ê³„ì‚°
                    updateBuyDplus(lastItem);
                    
                    // ê¸ˆì•¡ ìë™ ê³„ì‚°
                    const price = parseNumber(stockInfo.buyRows[i].price);
                    const qty = parseNumber(stockInfo.buyRows[i].quantity);
                    if (price > 0 && qty > 0) {
                        newRow.querySelector('.buy-total').value = formatNumber(Math.round(price * qty));
                    }
                }
                
                // ë§¤ë„ ì •ë³´ ë³µì›
                lastItem.querySelector('.sell1-date').value = stockInfo.sell1Date || '';
                lastItem.querySelector('.sell1-price').value = stockInfo.sell1Price || '';
                lastItem.querySelector('.sell2-date').value = stockInfo.sell2Date || '';
                lastItem.querySelector('.sell2-price').value = stockInfo.sell2Price || '';
                lastItem.querySelector('.sell3-date').value = stockInfo.sell3Date || '';
                lastItem.querySelector('.sell3-price').value = stockInfo.sell3Price || '';
                
                // ë§¤ë„ D+ì¼ ìë™ ê³„ì‚°
                updateSellDplus(lastItem);
                
                // ë§¤ë„ ìˆ˜ëŸ‰/ê¸ˆì•¡ ìë™ ê³„ì‚°
                calculateBuySellTotals(lastItem);
            });
        }
        
        // ì´ˆê¸°í™”
        window.onload = function() {
            // ì €ì¥ëœ ì…ë ¥ ë°ì´í„°ê°€ ìˆìœ¼ë©´ ë Œë”ë§
            const inputData = JSON.parse(localStorage.getItem('chart_stats_input_data') || '[]');
            if (inputData.length > 0) {
                restoreFromInputData(inputData);
            } else {
                addStock();
            }
            
            // êµ¬ê¸€ API ì´ˆê¸°í™”
            gapiLoaded();
            gisLoaded();
            
            // êµ¬ê¸€ API ì´ˆê¸°í™” ëŒ€ê¸° í›„ ë¡œê·¸ì¸ ìƒíƒœ ë³µì›
            const waitForInit = setInterval(async () => {
                if (gapiInited && gisInited) {
                    clearInterval(waitForInit);
                    await restoreLoginState();
                }
            }, 100);
        };
    </script>
</body>
</html>
